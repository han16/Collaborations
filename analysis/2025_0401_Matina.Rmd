---
title: "04/25 2025"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
date: "2025-04-25"
---




```{r, echo=F, message=F, warning=F}
library(rprojroot)
root <- rprojroot::find_rstudio_root_file()
source(file.path(root, "analysis/Rfunctions.R"))
root <- rprojroot::find_rstudio_root_file()
```




```{r, message=F, warning=F, results=F}
SDF=multiplesheets((file.path(root, "..\\2025\\202504\\Matina\\SDF.xlsx")))
SDF_data=SDF$Sheet1



# Define the follow-up columns
followup_cols <- c("3m", "6m", "9m", "12m", "15m", "18m", "24m")

# Extract the numeric months from the column names
months <- as.numeric(sub("m", "", followup_cols))

# Function to find the last time point with value 1
get_last_1_time <- function(row) {
  vals <- as.numeric(row[followup_cols])
  if (all(is.na(vals)) || all(vals != 1, na.rm = TRUE)) return(NA)
  max(months[which(vals == 1)])
}

# Apply the function to each row
SDF_data$Time <- apply(SDF_data, 1, get_last_1_time)


```



## overall success rate 

```{r, message=F, warning=F}
# Assuming '1' in the outcome column means success
success_rate <- colMeans(SDF_data[followup_cols] == 1, na.rm = TRUE)


# Define success rates
success_rate <- c(`3m` = 1.0000000,
                  `6m` = 0.9559748,
                  `9m` = 0.9119497,
                  `12m` = 0.8176101,
                  `15m` = 0.7352941,
                  `18m` = 0.6093750,
                  `24m` = 0.4000000)

# Convert to data frame
df <- data.frame(
  Month = factor(names(success_rate), levels = names(success_rate)),  # preserve order
  Rate = as.numeric(success_rate)
)

# Plot with distinct colors per bar
ggplot(df, aes(x = Month, y = Rate, fill = Month)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = sprintf("%.2f", Rate)),
            vjust = -0.5, size = 4) +
  labs(title = "",
       x = "Follow-up Time (Months)",
       y = "Success Rate") +
  ylim(0, 1.1) +
  theme(legend.position = "none")  # optional: hide legend if not needed
```


```{r, message=F, warning=F}
# Load required libraries
library(survival)
library(survminer)

# Create event indicator: 1 for success, 0 otherwise
SDF_data$Event <- ifelse(SDF_data$outcome == 1, 1, 0)

# Create a Surv object (time and event)
surv_obj <- Surv(time = SDF_data$Time, event = SDF_data$Event)

# Fit Kaplan-Meier model using the data argument
km_fit <- survfit(surv_obj ~ 1, data = SDF_data)

# Now plot with ggsurvplot, explicitly providing the data
ggsurvplot(km_fit,
           data = SDF_data,
           conf.int = TRUE,
           risk.table = TRUE,
           title = "Success Curve",
           xlab = "Time (months)",
           ylab = "Probability of Success",
           surv.scale = "percent")
```

* for outcome, treat `1` as success and failure otherwise. 


## survival by tooth types 

```{r, message=F, warning=F}
SDF_data_tooth_type=SDF_data %>%
  mutate(
    Tooth_Type = case_when(
      Tooth %in% c(51, 52, 61, 62, 73)        ~ "anterior",
      Tooth %in% c(74, 84)                    ~ "lower 1st molar",
      Tooth %in% c(75, 85)                    ~ "lower 2nd molar",
      Tooth %in% c(64, 54)                    ~ "upper 1st molar",
      Tooth %in% c(65, 55)                    ~ "upper 2nd molar",
      TRUE                                    ~ "other"
    )
  )
table(SDF_data_tooth_type$Tooth_Type)
```


```{r, message=F, warning=F}
# Step 1: Create the survival object
surv_obj <- Surv(time = SDF_data_tooth_type$Time, event = SDF_data_tooth_type$Event)

# Step 2: Fit the survival curves by Tooth_Type
fit <- survfit(surv_obj ~ Tooth_Type, data = SDF_data_tooth_type)

# Step 3: Plot with smaller font size in risk table
ggsurvplot(fit, data = SDF_data_tooth_type,
           pval = TRUE,
           risk.table = TRUE,
           risk.table.fontsize = 2,  # <-- adjust this number (default is ~4.5)
           legend.title = "Tooth Type",
           legend.labs = levels(factor(SDF_data_tooth_type$Tooth_Type)),
           xlab = "Time (months)",
           ylab = "Survival probability",
           ggtheme = theme_minimal())
```
* p value of 0.0054 indicates significant difference across tooth types 


### cox proportional hazard models 

```{r, message=F, warning=F}
cox_model <- coxph(Surv(Time, Event) ~ Tooth_Type, data = SDF_data_tooth_type)
summary(cox_model)
```
*  All molar types have significantly longer survival than anterior teeth. The hazard of failure is much lower for molars.

* Hazard Ratios (`exp(coef)`) < 1 mean better survival

* `Score (logrank) test = 12.5  on 4 df,   p=0.01` survival curves differ significantly across teeth types. 

*  Compared to anterior teeth, all molar types (lower 1st, lower 2nd, upper 1st, upper 2nd) show significantly better survival, with hazard ratios ranging from 0.22 to 0.35. This means molars have a 65–78% lower risk of failure over time compared to anterior teeth. 


## full model, including all covariates 


```{r, message=F, warning=F}
coxph(Surv(Time, Event) ~ Tooth_Type + Age + Sex + SSC, data = SDF_data_tooth_type)
```


Interpretation of Coefficients

* Tooth_Type (Reference: anterior)

Compared to anterior teeth:

Lower 1st molar: HR = 0.093 (p < 0.001)
→ 91% lower hazard; significantly better survival.

Lower 2nd molar: HR = 0.101 (p < 0.001)
→ 90% lower hazard; significantly better survival.

Upper 1st molar: HR = 0.153 (p < 0.001)
→ 85% lower hazard; significantly better survival.

Upper 2nd molar: HR = 0.083 (p < 0.001)
→ 92% lower hazard; significantly better survival.

* Age: HR = 1.18 (p = 0.0015)
→ For every one-month increase in age, the hazard increases by 18%. Older patients tend to have worse survival.

* Sex: HR = 1.18 (p = 0.37)
→ Not statistically significant. There is no strong evidence that survival differs by sex.

* SSC (Reference: 0 = No SSC): HR = 1.72 (p = 0.039)
→ Teeth with SSC have a 72% higher hazard, indicating worse survival, and the result is statistically significant.

* Model Fit Statistics
Likelihood ratio test: p = 0.0039

Wald test: p = 0.0039

Number of observations: 159

Number of events: 119

The model fit is statistically significant, suggesting that at least one predictor is significantly associated with survival.