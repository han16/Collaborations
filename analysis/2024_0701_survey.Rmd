---
title: "07/31/2024"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
---



```{r, echo=F, message=F, warning=F, results=F}
source("C:/Shengtong/Research/AllCollaboration/Collaborations/analysis/Rfunctions.R")
changeCellColor <- function(row, col){
  c(
    "function(row, data, num, index){",
    sprintf("  if(index == %d){", row-1),
    sprintf("    $('td:eq(' + %d + ')', row)", col),
    "    .css({'background-color': 'orange'});",
    "  }",
    "}"  
  )
}
```




```{r, echo=F, message=F, warning=F, results=F}
Dental_Hygienist=multiplesheets("C:\\Shengtong\\Research\\AllCollaboration\\2024\\202407\\state_survey\\Dental Hygienist.xlsx")
Dentist_Survey=multiplesheets("C:\\Shengtong\\Research\\AllCollaboration\\2024\\202407\\state_survey\\Dentist Survey.xlsx")
```


## Dental_Hygienist

```{r, message=F, warning=F}
#dim(Dental_Hygienist$`Dental H`)
variables=colnames(Dental_Hygienist$`Dental H`)
data.frame(questions=variables)%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

* in total 3991 responses and 46 questions 




### Race or Ethnicity

```{r, message=F, warning=F}
race=Dental_Hygienist$`Dental H` %>% dplyr::count(`Describe Your Race or Ethnicity`) %>% mutate(prop=round(n/nrow(Dental_Hygienist$`Dental H`),4))
asia=c("East Asian", "Filipino", "Hmong", "Laotian", "South Asian") # define south east asia countries 
asia_race= race %>% filter(`Describe Your Race or Ethnicity` %in% asia)
race_new=race %>% filter(`Describe Your Race or Ethnicity` %in% asia==F) %>% add_row(`Describe Your Race or Ethnicity`="asia", n=asia_race %>% select(n) %>% sum(), prop=asia_race %>% select(prop) %>% sum()) # combine south east asia countries into one unit 


g1=ggplot(race_new, aes(x=`Describe Your Race or Ethnicity`, y=n, fill=`Describe Your Race or Ethnicity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=race_new$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 5))

g2=ggplot(race_new, aes(x=`Describe Your Race or Ethnicity`, y=prop, fill=`Describe Your Race or Ethnicity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=race_new$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  guides(fill = guide_legend(nrow = 5))

figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Hygienist: 3991 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)

race_new%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(race_new$n)


## dual axis plot https://finchstudio.io/blog/ggplot-dual-y-axes/ https://r-graph-gallery.com/line-chart-dual-Y-axis-ggplot2.html   # https://stackoverflow.com/questions/3099219/ggplot-with-2-y-axes-on-each-side-and-different-scales
```

* `asia` includes "East Asian", "Filipino", "Hmong", "Laotian", "South Asian"



### Gender Identity

```{r, message=F, warning=F}
gender=Dental_Hygienist$`Dental H` %>% dplyr::count(`Gender Identity`) %>% mutate(prop=round(n/nrow(Dental_Hygienist$`Dental H`),4))

g1=ggplot(gender, aes(x=`Gender Identity`, y=n, fill=`Gender Identity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=gender$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))  #center the title

g2=ggplot(gender, aes(x=`Gender Identity`, y=prop, fill=`Gender Identity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=gender$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))  #center the title


figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Hygienist: 3991 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)



gender%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(gender$n)
```



## Dentist Survey

```{r, message=F, warning=F}
#dim(Dentist_Survey$`Dentist Survey`)
variables=colnames(Dentist_Survey$`Dentist Survey`)
data.frame(questions=variables)%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

* in total 2957 responses and 40 questions 


### Race or Ethnicity

```{r, message=F, warning=F}
race=Dentist_Survey$`Dentist Survey` %>% dplyr::count(`Describe Your Race or Ethnicity`) %>% mutate(prop=round(n/nrow(Dentist_Survey$`Dentist Survey`),4))
asia=c("East Asian", "Filipino", "Hmong", "Laotian", "South Asian") # define south east asia countries 
asia_race= race %>% filter(`Describe Your Race or Ethnicity` %in% asia)
race_new=race %>% filter(`Describe Your Race or Ethnicity` %in% asia==F) %>% add_row(`Describe Your Race or Ethnicity`="asia", n=asia_race %>% select(n) %>% sum(), prop=asia_race %>% select(prop) %>% sum()) # combine south east asia countries into one unit 

race_new2=race_new %>% filter(n>10)  %>% add_row(`Describe Your Race or Ethnicity`="other", n=race_new %>% filter(n<=10) %>% select(n) %>% sum(), prop=race_new %>% filter(n<=10) %>% select(prop) %>% sum()) # aggregate categories with n<=10 

g1=ggplot(race_new2, aes(x=`Describe Your Race or Ethnicity`, y=n, fill=`Describe Your Race or Ethnicity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=race_new2$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle(" ")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  guides(fill = guide_legend(nrow = 5))

g2=ggplot(race_new2, aes(x=`Describe Your Race or Ethnicity`, y=prop, fill=`Describe Your Race or Ethnicity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=race_new2$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle(" ")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  guides(fill = guide_legend(nrow = 5))

figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Dentist: 2957 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)




race_new2%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

sum(race_new2$n)
```

* `asia` includes "East Asian", "Filipino", "Hmong", "Laotian", "South Asian"

* `other` aggregates categories with less than 10 responses. 



### Gender Identity

```{r, message=F, warning=F}
gender=Dentist_Survey$`Dentist Survey` %>% dplyr::count(`Gender Identity`) %>% mutate(prop=round(n/nrow(Dentist_Survey$`Dentist Survey`),4))

g1=ggplot(gender, aes(x=`Gender Identity`, y=n, fill=`Gender Identity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=gender$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("Dentist ")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 3))

g2=ggplot(gender, aes(x=`Gender Identity`, y=prop, fill=`Gender Identity`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=gender$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("Dentist ")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 3))

figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Dentist: 2957 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)


gender%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(gender$n)
```




### Dental Specialties Board Certified


```{r, message=F, warning=F}
specialty=Dentist_Survey$`Dentist Survey` %>% dplyr::count(`Dental Specialties Board Certified`) %>% mutate(prop=round(n/nrow(Dentist_Survey$`Dentist Survey`),4))

specialty2=specialty %>% filter(n>10)  %>% add_row(`Dental Specialties Board Certified`="other", n=specialty %>% filter(n<=10) %>% select(n) %>% sum(), prop=specialty %>% filter(n<=10) %>% select(prop) %>% sum()) # aggregate categories with n<=10 



g1=ggplot(specialty2, aes(x=`Dental Specialties Board Certified`, y=n, fill=`Dental Specialties Board Certified`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=specialty2$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 4))

g2=ggplot(specialty2, aes(x=`Dental Specialties Board Certified`, y=prop, fill=`Dental Specialties Board Certified`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=specialty2$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 4))

figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Dentist: 2957 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)


specialty2%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(specialty2$n)
```


* `other` aggregates categories with less than 10 responses, such as `General dentistry; Oral surgery`




### Best Describes This Practice Setting


```{r, message=F, warning=F}
practice_setting=Dentist_Survey$`Dentist Survey` %>% dplyr::count(`Best Describes This Practice Setting`) %>% mutate(prop=round(n/nrow(Dentist_Survey$`Dentist Survey`),4))

threshold=20
practice_setting2=practice_setting %>% filter(n>threshold)  %>% add_row(`Best Describes This Practice Setting`="other", n=practice_setting %>% filter(n<=threshold) %>% select(n) %>% sum(), prop=practice_setting %>% filter(n<=threshold) %>% select(prop) %>% sum()) # aggregate categories with n<=10 



g1=ggplot(practice_setting2, aes(x=`Best Describes This Practice Setting`, y=n, fill=`Best Describes This Practice Setting`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="", legend.title=element_text(size=10))+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=practice_setting2$n), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 5))

g2=ggplot(practice_setting2, aes(x=`Best Describes This Practice Setting`, y=prop, fill=`Best Describes This Practice Setting`)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("%")+xlab("")+
  theme(legend.position="", legend.title=element_text(size=10))+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label=practice_setting2$prop*100), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("")+
  theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
   guides(fill = guide_legend(nrow = 5))

figure=ggarrange(g1, g2, common.legend = TRUE, legend="bottom") 
annotate_figure(figure,
                top = text_grob("Dentist: 2957 responses", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold")

)


practice_setting2%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(practice_setting2$n)
```

`other` aggregates categories with responses less than 20. 


## geographical distribution 

```{r, message=F, warning=F, results=F}
wisconsin_urban_rural_zip=multiplesheets("C:\\Shengtong\\Research\\OralPublicHealth\\Dental_Emergency_visit\\Wisconsin-Urban-Rural-zip.xlsx")
```


* [Wisconsin state urban rural code](https://marq-my.sharepoint.com/:x:/g/personal/shengtong_han_marquette_edu/ETU5WgJJl9BIoNsBBNhPqocBR3DcuAN3q1H65LThX3eeuQ?e=Ozruo2)



```{r, message=F, warning=F}
region_code=unique(wisconsin_urban_rural_zip$`Table 1`$`2014 ZCTA-based WURC Code`)
all_code=wisconsin_urban_rural_zip$`Table 1`$`2014 ZCTA-based WURC Code`
all_code[which(all_code=="R2/R1")]="R2"   # raname regions 
all_code[which(all_code=="Urban/R1")]="Urban"
all_code[which(all_code=="Metro W-O-W/R1")]="Metro W-O-W"
all_code[which(all_code=="R3/R1")]="R3"
all_code[which(all_code=="R3/R2/R1")]="R3"
all_code[which(all_code=="Urban/R2")]="Urban"
all_code[which(all_code=="R1/Urban")]="R1"
wisconsin_urban_rural_zip_data=wisconsin_urban_rural_zip$`Table 1` %>% mutate(new_region_code=all_code)
region_code_update=unique(all_code)
```


```{r, message=F, warning=F}
region_code_zip=sapply(region_code_update, function(x) wisconsin_urban_rural_zip_data %>% filter(new_region_code==x) %>% select(`ZCTA/\r\nZIPCode`)) # extract zip codes 
hygienist_zip=unique(Dental_Hygienist$`Dental H` %>% select(`5-digit Zip code` ) %>% pull)

#zip_in_hygie_only=setdiff(hygienist_zip, unlist(region_code_zip)) #### zip codes in the survey, but not in wisconsin urban rural zip data 
# Dental_Hygienist$`Dental H` %>% filter(`5-digit Zip code` %in% zip_in_hygie_only)%>% filter(`Gender Identity`=="Man" | `Gender Identity`=="Woman") %>% nrow() these man/woman in the survey, but missed in wisconsin urban/rural data 


#dentist_zip=unique(Dentist_Survey$`Dentist Survey` %>% select(`5-digit Zip code` ) %>% pull)
#zip_in_dentist_only=setdiff(dentist_zip, unlist(region_code_zip)) #### zip codes in the survey, but not in wisconsin urban rural zip data 
#Dentist_Survey$`Dentist Survey` %>% filter(`5-digit Zip code` %in% zip_in_dentist_only)%>% filter(`Gender Identity`=="Man" | `Gender Identity`=="Woman") %>% nrow() # these 886 man/woman in the survey, but missed in wisconsin urban/rural data

```

### Gender Identity

```{r, message=F, warning=F}

gender_geo=sapply(region_code_zip, function(x) Dental_Hygienist$`Dental H` %>% filter(`5-digit Zip code` %in% x) %>% select(`Gender Identity`))
gender_prop=sapply(gender_geo, function(x) c(sum(x=="Man", na.rm = T), sum(x=="Woman", na.rm = T))) 
gender_geo_data=data.frame(geo=rep(region_code_update,each=2), num=as.vector(gender_prop), gender=rep(c("Man", "Woman"), length(region_code_update))) %>% drop_na()


ggplot(gender_geo_data, aes(x=geo, y=num, fill=gender)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size=10))+
  geom_text(aes(label=num), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("Hygienist ")+
  theme(plot.title = element_text(hjust = 0.5, size=15))  #center the title



gender_geo_data%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

### sum(gender_geo_data$num) is not but should be equal to Dental_Hygienist$`Dental H`%>% filter(`Gender Identity`=="Man" | `Gender Identity`=="Woman") %>% nrow()  ?????????? 
```
* only keep `Man` and `Woman` and ignore other responses 




```{r, message=F, warning=F}
gender_geo=sapply(region_code_zip, function(x) Dentist_Survey$`Dentist Survey` %>% filter(`5-digit Zip code` %in% x) %>% select(`Gender Identity`))
gender_prop=sapply(gender_geo, function(x) c(sum(x=="Man", na.rm=T), sum(x=="Woman", na.rm=T))) 
gender_geo_data=data.frame(geo=rep(region_code_update,each=2), num=as.vector(gender_prop), gender=rep(c("Man", "Woman"), length(region_code_update))) %>% drop_na()


ggplot(gender_geo_data, aes(x=geo, y=num, fill=gender)) +geom_bar(position = "dodge", stat="identity")+
 # ylim(c(0, 0.7))+
  ylab("n")+xlab("")+
  theme(legend.position="bottom")+
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, size=10))+
  geom_text(aes(label=num), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("Dentist_Survey")+
  theme(plot.title = element_text(hjust = 0.5, size=15))  #center the title


gender_geo_data%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(gender_geo_data$num)
```



### specialty distribution 





```{r, message=F, warning=F}
specialty=c("General dentistry", "Endodontics", "Orthodontics","Periodontics",  "Prosthodontics", "Pediatric dentistry", "Oral surgery")
specialty_geo=sapply(region_code_zip, function(x) Dentist_Survey$`Dentist Survey` %>% filter(`5-digit Zip code` %in% x) %>% filter(`Dental Specialties Board Certified` %in% specialty) %>% select(`Dental Specialties Board Certified`))
specialty_prop=sapply(specialty_geo, function(x) c(sum(x=="General dentistry"), sum(x=="Endodontics"), sum(x=="Orthodontics"), sum(x=="Periodontics"), sum(x=="Prosthodontics"), sum(x=="Pediatric dentistry"), sum(x=="Oral surgery"))) 
specialty_geo_data=data.frame(geo=rep(region_code_update,each=length(specialty)), num=as.vector(specialty_prop), spect=rep(specialty, length(region_code_update))) %>% drop_na()

figures=list()
pie_chart=list()
for (i in 1:length(region_code_update))
  
{
   figures[[i]]=ggplot(specialty_geo_data %>% filter(geo %in% region_code_update[i]), aes(x=spect, y=num, fill=spect)) +geom_bar(position = "dodge", stat="identity")+
  ylim(c(0, max(specialty_geo_data %>% filter(geo %in% region_code_update[i]) %>% select(num)%>% pull())+10))+
  facet_grid("geo")+
  ylab("n")+xlab("")+
  theme(legend.position="")+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5, size=10))+
  geom_text(aes(label=num), position=position_dodge(width=0.9), vjust=-0.25, size=3)+  # add numbers over bars
  ggtitle("Dentist_Survey")+
  theme(plot.title = element_text(hjust = 0.5, size=15))  #center the title
  
  pie_data=specialty_geo_data %>% filter(geo %in% region_code_update[i])
  pie_data <- pie_data %>% 
  mutate(per=`num`/sum(`num`)) %>% 
  arrange(desc(spect))
pie_data$label <- scales::percent(pie_data$per)
pie_chart[[i]]=ggplot(data=pie_data)+
  geom_bar(aes(x="", y=per, fill=spect), stat="identity", width = 1)+
  coord_polar("y", start=0)+
  theme_void()+
  geom_text(aes(x=1, y = cumsum(per) - per/2, label=label))
   
   
}
  
ggarrange(figures[[1]], figures[[2]], figures[[3]], figures[[4]], figures[[5]], figures[[6]], ncol=2)






gender_geo_data%>%
datatable(extensions = 'Buttons',
          caption = "",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
sum(gender_geo_data$num)
```