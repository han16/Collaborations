---
title: "response to comments"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
date: "2026-01-28"
---

```{r, echo=F, message=F, warning=F, results=F}
library(rprojroot)
root <- rprojroot::find_rstudio_root_file()
source(file.path(root, "analysis/Rfunctions.R"))
root <- rprojroot::find_rstudio_root_file()
```


```{r, message=F, warning=F, results=F}
precision=read_xlsx((file.path(root, "../2026/202601/Arndt/Precision_FALCON_Smart Glasses.xlsx")))
trueness=read_xlsx((file.path(root, "../2026/202601/Arndt/Trueness_FALCON_Smart Glasses.xlsx")))
```



* [main analysis](https://han16.github.io/Collaborations/2023_1102_Arndt.html)


## linear mixed effect model (LMM)

consider the LLM as 

$$y_{ij}=\beta_0+\beta_1 \times Position_{ij}+\mu_i+\epsilon_{ij}
$$


1. $y_{ij}$ is the outcome variable, $i$ is the patient index, $j$ is the implant position index 

2. $\beta_0$ random intercept for patients 

3. $\beta_1$ fixed effect for implant position 

4. $\mu_i \sim N(0, \sigma^2_{patient})$, random effect for subject $i$. 

5. $\epsilon_{ij} \sim (0, \sigma^2)$



### workflow 2: dCAIS



```{r, message=F, warning=F}
data_dCAIS <- trueness %>% filter(Workflow==2)  %>%
  mutate(
    patient = sub("_.*", "", Sample),  # D01, D02, ...
    patient = factor(patient),
    Position = factor(Position)        # treat positions as fixed categories
  )
library(lme4)
library(Matrix)
m_angle <- lmer(
  Angle ~ Position + (1 | patient),
  data = data_dCAIS
)



isSingular(m_angle)        # TRUE/FALSE
summary(m_angle)
VarCorr(m_angle)           # shows variance of random effects

```


```{r, message=F, warning=F}
library(broom.mixed)
library(lmerTest)

outcomes <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
              "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")

results_list <- lapply(outcomes, function(yvar) {
  # Fit LMM with lmerTest to get p-values
  mod <- lmer(as.formula(paste(yvar, "~ Position + (1 | patient)")), data = data_dCAIS)
  
  # Fixed effects with p-values
  fe <- broom.mixed::tidy(mod, effects = "fixed") %>%
    select(term, estimate, std.error, statistic, p.value) %>%
    mutate(
      estimate = round(estimate, 4),
      std.error = round(std.error, 4),
      statistic = round(statistic, 4),
      p.value = round(p.value, 4),
      outcome = yvar
    )
  
  # Random effects variance
  re <- as.data.frame(lme4::VarCorr(mod)) %>%
    select(grp, var1, vcov) %>%
    rename(Group = grp, RandomEffect = var1, Variance = vcov) %>%
    mutate(
      Variance = round(Variance, 4),
      outcome = yvar
    )
  
  list(fixed = fe, random = re)
})


fixed_table <- do.call(rbind, lapply(results_list, `[[`, "fixed")) %>%
  select(outcome, term, estimate, std.error, statistic, p.value)

fixed_table%>%
datatable(extensions = 'Buttons',
          caption = "fixed effect", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))


random_table <- do.call(rbind, lapply(results_list, `[[`, "random")) %>%
  select(outcome, Group, RandomEffect, Variance)

random_table%>%
datatable(extensions = 'Buttons',
          caption = "random effect", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```



* Position17 is the reference 




## anova for repeated measures 


```{r, message=F, warning=F}
library(afex)

outcomes <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
              "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")


data_dCAIS$patient  <- factor(data_dCAIS$patient)
data_dCAIS$Position <- factor(data_dCAIS$Position)

anova_results <- lapply(outcomes, function(y) {
  formula <- as.formula(
    paste(y, "~ Position + Error(patient / Position)")
  )
  fit <- aov(formula, data = data_dCAIS)
  summary(fit)
})

names(anova_results) <- outcomes


#anova_results

extract_p <- function(aov_summary) {
  aov_summary[["Error: patient:Position"]][[1]]["Position", "Pr(>F)"]
}
p_values <- sapply(anova_results, extract_p)
p_values
```




### workflow 3: dCAIS+SG



```{r, message=F, warning=F}
data_dCAIS_SG <- trueness %>% filter(Workflow==3)  %>%
  mutate(
    patient = sub("_.*", "", Sample),  # D01, D02, ...
    patient = factor(patient),
    Position = factor(Position)        # treat positions as fixed categories
  )
library(lme4)
library(Matrix)
m_angle <- lmer(
  Angle ~ Position + (1 | patient),
  data = data_dCAIS
)



isSingular(m_angle)        # TRUE/FALSE
summary(m_angle)
VarCorr(m_angle)           # shows variance of random effects

```





```{r, message=F, warning=F}
library(broom.mixed)
library(lmerTest)

outcomes <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
              "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")

results_list <- lapply(outcomes, function(yvar) {
  # Fit LMM with lmerTest to get p-values
  mod <- lmer(as.formula(paste(yvar, "~ Position + (1 | patient)")), data = data_dCAIS_SG)
  
  # Fixed effects with p-values
  fe <- broom.mixed::tidy(mod, effects = "fixed") %>%
    select(term, estimate, std.error, statistic, p.value) %>%
    mutate(
      estimate = round(estimate, 4),
      std.error = round(std.error, 4),
      statistic = round(statistic, 4),
      p.value = round(p.value, 4),
      outcome = yvar
    )
  
  # Random effects variance
  re <- as.data.frame(lme4::VarCorr(mod)) %>%
    select(grp, var1, vcov) %>%
    rename(Group = grp, RandomEffect = var1, Variance = vcov) %>%
    mutate(
      Variance = round(Variance, 4),
      outcome = yvar
    )
  
  list(fixed = fe, random = re)
})


fixed_table <- do.call(rbind, lapply(results_list, `[[`, "fixed")) %>%
  select(outcome, term, estimate, std.error, statistic, p.value)

fixed_table%>%
datatable(extensions = 'Buttons',
          caption = "fixed effect", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))


random_table <- do.call(rbind, lapply(results_list, `[[`, "random")) %>%
  select(outcome, Group, RandomEffect, Variance)

random_table%>%
datatable(extensions = 'Buttons',
          caption = "random effect", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```


## anova for repeated measures 


```{r, message=F, warning=F}
library(afex)

outcomes <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
              "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")


data_dCAIS_SG$patient  <- factor(data_dCAIS_SG$patient)
data_dCAIS_SG$Position <- factor(data_dCAIS_SG$Position)

anova_results <- lapply(outcomes, function(y) {
  formula <- as.formula(
    paste(y, "~ Position + Error(patient / Position)")
  )
  fit <- aov(formula, data = data_dCAIS_SG)
  summary(fit)
})

names(anova_results) <- outcomes


#anova_results

extract_p <- function(aov_summary) {
  aov_summary[["Error: patient:Position"]][[1]]["Position", "Pr(>F)"]
}
p_values <- sapply(anova_results, extract_p)
p_values
```


## power analysis 

```{r, message=F, warning=F}
outcomes <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
              "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")
Position=17
n=20; delta=mean(data_dCAIS%>%filter(Position=="17") %>% select("Angle")%>% pull())-mean(data_dCAIS_SG%>%filter(Position=="17")%>% select("Angle")%>% pull())
sd=mean(c(sd(data_dCAIS%>%filter(Position=="17") %>% select("Angle")%>% pull()), sd(data_dCAIS_SG%>%filter(Position=="17") %>% select("Angle")%>% pull())))
power.t.test(n, delta, sd)
```





```{r, message=F, warning=F}
outcomes  <- c("Angle", "Base3Doffset", "Basedistal", "Basevestibular", "Baseapical",
               "Tip3Doffset", "Tipdistal", "Tipvestibular", "Tipapical", "Apical")

positions <- c("17", "18", "19", "29", "30")

n <- 20


compute_power <- function(outcome, pos) {

  x1 <- data_dCAIS     %>% filter(Position == pos) %>% pull(!!sym(outcome))
  x2 <- data_dCAIS_SG  %>% filter(Position == pos) %>% pull(!!sym(outcome))

  # remove NAs
  x1 <- x1[!is.na(x1)]
  x2 <- x2[!is.na(x2)]

  # skip if not enough data
  if (length(x1) < 2 || length(x2) < 2) {
    return(tibble(
      Outcome = outcome,
      Position = pos,
      delta = NA_real_,
      sd = NA_real_,
      power = NA_real_
    ))
  }

  delta <- abs(mean(x1) - mean(x2))
  sdval <- (sd(x1)+sd(x2))/2

  pwr <- power.t.test(
    n = n,
    delta = delta,
    sd = sdval,
    type = "paired",
    alternative = "two.sided"
  )$power

  tibble(
    Outcome  = outcome,
    Position = pos,
    delta    = delta,
    sd       = sdval,
    power    = pwr
  )
}

library(purrr)
library(dplyr)

power_results <- crossing(
  Outcome = outcomes,
  Position = positions
) %>%
  pmap_dfr(~ compute_power(..1, ..2))



power_results %>%
  mutate(
    delta = round(delta, 4),
    sd    = round(sd, 4),
    power = round(power, 3)
  )%>%
datatable(extensions = 'Buttons',
          caption = " ", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))



```