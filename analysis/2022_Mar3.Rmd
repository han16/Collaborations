---
title: "3/29/2022"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr) # combine and arrange multiple 
library(rstatix) # use anova_test function 
set.seed(123)
```

```{r, echo=F, echo=F, message=F}
data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\FullDataSAI.csv", header=T))
```


## response and potential predictors 

### PBI (papillary bleeding index)

#### trajectory plot 

* measurements are taken at 2 time points, `PBI.Screening`, `PBI.8.wk`, and are longitudinal data 

```{r, echo=F, message=F, warning=F}
#data_long=data.frame(PBI=c(data$PBI.Screening, data$PBI.8.wk), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(seq(1, nrow(data)),2))

data_long=data.frame(PBI=c(data$PBI.Screening, data$PBI.8.wk), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(data$Patient.ID.Number,2))

g1=ggplot(data=data_long,aes(x=time, y=PBI, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_mean=c(mean(data$PBI.Screening),mean(data$PBI.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.8.wk, data$PBI.Screening), max(data$PBI.8.wk, data$PBI.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure 
```


#### summary statistics 

```{r, echo=F, message=F, warning=F}
data_long %>%
  group_by(time) %>%
  get_summary_stats(PBI, type = "mean_sd")
```

#### boxplot 


```{r, echo=F, warning=F, message=F}
bxp <- ggboxplot(data_long, x = "time", y = "PBI", add = "point")
bxp
```

#### outlier detection 



```{r, echo=F, message=F, warning=F}
data_long %>% 
  group_by(time) %>% 
  identify_outliers(PBI)
```

#### normality assumption 

```{r, echo=F, message=F, warning=F}
data_long %>% group_by(time) %>% shapiro_test(PBI)
```

* all p values are bigger than 0.05, suggesting they are normally distributed. 

```{r, echo=F, message=F, warning=F}
ggqqplot(data_long, "PBI", facet.by="time")
```


* most points fall along reference line, normality assumption is reasonable. 





```{r, echo=F, message=F, warning=F}
res.aov <- anova_test(data = data_long, dv = PBI, wid = individual, within = time)

get_anova_table(res.aov)
```
 * [anova_test](https://search.r-project.org/CRAN/refmans/rstatix/html/anova_test.html) repeated measures ANOVA 
 
 * PBI: dependent variable 
 
 * PIB are statistical different between screening and week 8 by small p value of 0.032. 
 
 
 
```{r, echo=F, message=F, warning=F}
pwc=data_long %>% pairwise_t_test(PBI ~ time, paired=T, p.adjust.method = "bonferroni")
pwc=pwc %>%add_xy_position(x="time")

bxp+
  stat_pvalue_manual(pwc)+
  labs(subtitle=get_test_label(res.aov, detailed = T), caption=get_pwc_label(pwc))

```
 

### SAI (sleep apnea index) - two way repeated anova 


Each individual has one single SAI for both before and after the screening. 


```{r, echo=F, warning=F, message=F}
sai_group1=data%>%filter(SAI<5)  # split sample into 3 groups by SAI 
sai_group2=data%>%filter(SAI>=5 & SAI<=15)
sai_group3=data%>%filter(SAI>15)
                         
data_long_sai_group1=data.frame(PBI=c(sai_group1$PBI.Screening, sai_group1$PBI.8.wk),  time=rep(c("screening", "week 8"), each=nrow(sai_group1)), individual=rep(sai_group1$Patient.ID.Number,2), group=rep("SAI<5", 2*nrow(sai_group1)))
data_long_sai_group2=data.frame(PBI=c(sai_group2$PBI.Screening, sai_group2$PBI.8.wk),  time=rep(c("screening", "week 8"), each=nrow(sai_group2)), individual=rep(sai_group2$Patient.ID.Number,2), group=rep("SAI>=5, SAI<=15", 2*nrow(sai_group2)))
data_long_sai_group3=data.frame(PBI=c(sai_group3$PBI.Screening, sai_group3$PBI.8.wk),  time=rep(c("screening", "week 8"), each=nrow(sai_group3)), individual=rep(sai_group3$Patient.ID.Number,2), group=rep("SAI>15", 2*nrow(sai_group3)))
data_long_sai=rbind(data_long_sai_group1, data_long_sai_group2, data_long_sai_group3)


```


#### summary statistics 

```{r, echo=F, message=F, warning=F}
data_long_sai %>% group_by(group, time) %>% get_summary_stats(PBI, type="mean_sd")
```

```{r, echo=F, message=F, warning=F}
bxp=ggboxplot(data_long_sai, x="time", y="PBI", color="group", palette="jco")
bxp
```


#### outliers 

```{r, echo=F, message=F, warning=F}
data_long_sai %>% group_by(group, time) %>% identify_outliers(PBI)
```
no outliers 

#### normality assumption 

```{r, echo=F, warning=F, message=F}
data_long_sai %>% group_by(group, time) %>% shapiro_test(PBI)
```

Normal distribution is a reasonable by large p values 

```{r, echo=F, message=F, warning=F}
ggqqplot(data_long_sai, "PBI", ggtheme=theme_bw())+
  facet_grid(time ~ group, labeller="label_both")
```

#### results 

```{r, echo=F, warning=F, message=F, eval=T}
#data_long_sai_two=data_long_sai%>% filter(group!="SAI>15")
#res.aov=anova_test(data=data_long_sai_two, dv=PBI, wid=individual, within=c(time, group))
#get_anova_table(res.aov)

res.aov = anova_test(
  data = data_long_sai, 
  PBI ~ group * time,
  wid = individual
)
get_anova_table(res.aov)

```

* big p values (>0.05) indicate no main or interaction effects 


```{r, echo=F, message=F, warning=F}
# anova test at every time point 
data_long_sai_screeing=data_long_sai %>% filter(time=="screening")
res.aov <- aov(PBI ~ group, data = data_long_sai_screeing)
# Summary of the analysis
summary(res.aov)
```
* no PBI difference among 3 groups at screening 


```{r, echo=F, message=F, warning=F}
# anova test at every time point 
data_long_sai_screeing=data_long_sai %>% filter(time=="week 8")
res.aov <- aov(PBI ~ group, data = data_long_sai_screeing)
# Summary of the analysis
summary(res.aov)
```

* no difference among 3 groups at week 8 


```{r, echo=F, message=F, warning=F}
#data_long_sai %>% pairwise_t_test(PBI~group, paired = T, p.adjust.method = "bonferroni")
data_long_sai %>% pairwise_t_test(PBI~time, paired = T, p.adjust.method = "bonferroni") # comparison for time variables 
```

* there is difference between screening and week 8. 

## statistical software 

```{r, echo=F}
R.version
```

