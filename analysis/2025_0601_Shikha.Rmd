---
title: "06/04 2025"
output:
  workflowr::wflow_html:
    code_folding: hide
    toc: true
date: "2025-06-04"
---




```{r, echo=F, message=F, warning=F, results=F}
library(rprojroot)
root <- rprojroot::find_rstudio_root_file()
source(file.path(root, "analysis/Rfunctions.R"))
root <- rprojroot::find_rstudio_root_file()
```




```{r, message=F, warning=F, results=F, eval=F}
data_raw=multiplesheets((file.path(root, "..\\2025\\202506\\Shikha\\Gupta Endo Data.xlsx")))
endo_cases=data_raw$EndoCases
endo_cases=endo_cases %>% mutate(tooth=paste0(endo_cases$`Patient...1`, ":", endo_cases$`Site...4`))

post_endo_tx=data_raw$`Post Endo TX`
post_endo_tx=post_endo_tx %>% mutate(tooth=paste0(post_endo_tx$Patient, ":", post_endo_tx$Site))

#saveRDS(endo_cases, file=file.path(root, "..\\2025\\202506\\Shikha\\endo_cases.RDS"))
#saveRDS(post_endo_tx, file=file.path(root, "..\\2025\\202506\\Shikha\\post_endo_tx.RDS"))

```



## workflow 


1. `EndoCases`: 45,119 teeth in total, but 30,680 unique teeth ---> apply 3 root canal codes, keep the the last root canal date: 30680 teeth.  



2. `post Endo Tx`: 548,918 teeth, but 358,560 unique ones; among them, 192,958 Endo check yes ---> apply final restoration code+endo check yes: 103,341 --->  Filter restorations that occurred *after* or the same day as root canal: 10286 teeth (rows).  


## step 1: root canal 


```{r, message=F, warning=F}
endo_cases=readRDS(file.path(root, "..\\2025\\202506\\Shikha\\endo_cases.RDS"))
post_endo_tx=readRDS(file.path(root, "..\\2025\\202506\\Shikha\\post_endo_tx.RDS"))

# Create a data frame
root_canal_codes <- data.frame(
  Code = c("D3310", "D3320", "D3330"),
  Description = c(
    "anterior RCT",
    "bicuspid RCT",
    "molar RCT"
  )
)

root_canal_codes%>%
datatable(extensions = 'Buttons',
          caption = "root canal Codes", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```




```{r, message=F, warning=F}
length(unique(endo_cases$tooth))

endo_cases_with_root_canal=endo_cases %>% filter(`Procedure...5` %in% root_canal_codes$Code)%>%
  group_by(tooth) %>%
  arrange(`Date...7`) %>%
  slice_tail(n = 1) %>%  # Keeps the last root canal date
  ungroup()

endo_cases_with_root_canal$`Date...7`=as.Date(endo_cases_with_root_canal$`Date...7`)
endo_cases_with_root_canal$Birth=as.Date(endo_cases_with_root_canal$Birth)

endo_cases_with_root_canal %>%
datatable(extensions = 'Buttons',
          caption = " patient and tooth with root canal codes", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

```


* only keep the latest root canal if the tooth has multiple root canals at different dates. 




```{r, message=F, warning=F}
# Count the number of each Procedure
procedure_counts <- endo_cases_with_root_canal %>%dplyr::count(`Procedure...5`)

# Bar plot
ggplot(procedure_counts, aes(x = `Procedure...5`, y = n, fill=`Procedure...5`)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  labs(
    title = "",
    x = "Procedure Code",
    y = "Count"
  ) +
  theme_minimal() +
  theme(
    text = element_text(size = 14),
    legend.position = "", 
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

```





## step 2: initial treatment 


```{r, message=F, warning=F}
# Create a data frame of Final Restoration codes
final_restoration_codes <- data.frame(
  Code = c(
    "D2390", "D2391", "D2392", "D2393", "D2394",
    "D2650", "D2651", "D2652", "D2662", "D2663", "D2664",
    "D2710", "D2712", "D2720", "D2721", "D2722",
    "D2910", "D2915", "D2920", "D2932", "D2933",
    "D2940", "D2949", "D2950", "D2951", "D2952", "D2954",
    "D6068", "D6069", "D6070", "D6071", "D6072", "D6073", "D6074",
    "D6545", "D6548", "D6611",
    "D6710", "D6720", "D6721", "D6722",
    "D6740", "D6750", "D6780", "D6790", "D6793",
    "D6930", "D6971"
  ),
  Description = c(
    "Resin-based comp crown, ant.",
    "Resin-based comp - 1 surface, posterior",
    "Resin-based comp - 2 surfaces, posterior",
    "Resin-based comp - 3 surfaces, posterior",
    "Resin-based comp - 4+ surfaces, posterior",
    "Inlay - resin - 1 surface",
    "Inlay - resin - 2 surfaces",
    "Inlay - resin - 3 or more",
    "Onlay - resin - 2 surfaces",
    "Onlay - resin - 3 surfaces",
    "Onlay - resin - 4 or more",
    "Resin crown - laboratory",
    "Crown - 3/4 resin-based comp",
    "Resin crown - high noble metal",
    "Resin crown - predominately base metal",
    "Resin crown - noble metal",
    "Recement/re-bond inlay/onlay",
    "Recement cast or prefab post",
    "Recement/re-bond crown",
    "Prefabricated resin crown",
    "Prefab stainless steel crown w/ resin window",
    "Protective restoration",
    "Restorative foundation/indirect restoration",
    "Core buildup - including pins",
    "Pin retention - per tooth",
    "Post & core, indirect fabrication",
    "Prefab post and core",
    "Abutment-retainer, porcelain/ceramic FPD",
    "Abutment-ret., PFM FPD, high noble",
    "Abutment-ret., PFM FPD, base metal",
    "Abutment-ret., PFM FPD, noble metal",
    "Abut-ret., cast metal, high noble",
    "Abut-ret., cast metal, base metal",
    "Abut-ret., cast metal, noble metal",
    "Retainer, metal, resin-bonded FPD",
    "Retainer, porcelain/ceramic, bonded FPD",
    "Retainer onlay, high noble metal, 3+ surfaces",
    "Crown - indirect resin-based",
    "Crown - resin, high noble metal",
    "Crown - resin, predominately base metal",
    "Crown - resin, noble metal",
    "Retainer crown - porcelain/ceramic",
    "Retainer crown - porcelain fused to high noble metal",
    "Retainer crown - 3/4 cast, high noble metal",
    "Retainer crown - full cast, high noble metal",
    "Provisional retainer crown",
    "Recement/re-bond FPD",
    "Cast post - part of FPD retainer"
  )
)

dim(post_endo_tx)
length(unique(post_endo_tx$tooth))



post_endo_tx_with_final_restoration_codes=post_endo_tx %>% filter(Procedure %in% final_restoration_codes$Code )
#%>% filter(`Endo Check`=="Yes")  this time the data doesn't have endo check column 

final_restoration_codes%>%
datatable(extensions = 'Buttons',
          caption = "restoration codes", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))

dim(post_endo_tx_with_final_restoration_codes)
```




## time period between root canal and inital treatment 



```{r, message=F, warning=F}

# Ensure Date columns are Date type
endo_cases_with_root_canal$`Date...7` <- as.Date(endo_cases_with_root_canal$`Date...7`)
post_endo_tx_with_final_restoration_codes$Date <- as.Date(post_endo_tx_with_final_restoration_codes$Date)

# Step 1: Rename columns for clarity
endo_root <- endo_cases_with_root_canal %>%
  rename(
    root_canal_date = `Date...7`,
    root_canal_procedure = `Procedure...5`, 
    producer=`Producer...6`
  )

restoration <- post_endo_tx_with_final_restoration_codes %>%
  rename(
    restoration_date = Date,
    restoration_procedure = Procedure
  )

# Step 2: Perform inner join on tooth, retaining all necessary columns explicitly
joined <- endo_root %>%
  select(`Patient...1`, tooth, root_canal_date, root_canal_procedure, producer) %>%
  inner_join(restoration %>% select(tooth, restoration_date, restoration_procedure),
             by = "tooth")
dim(joined)

# Step 3: Filter restorations that occurred *after* or the same day as root canal
after_root_canal <- joined %>%
  filter(restoration_date >= root_canal_date)

before_root_canal <- joined %>%
  filter(restoration_date < root_canal_date)

dim(after_root_canal)

# Step 4: Group by root canal event (Patient + tooth + date) and get earliest restoration
first_restoration <- after_root_canal %>%
  group_by(`Patient...1`, tooth, root_canal_date) %>%
  arrange(restoration_date) %>%
  slice(1) %>%
  ungroup()

dim(first_restoration)

# Step 5: Calculate time difference and select output columns
endo_with_tx_time <- first_restoration %>%
  mutate(
    time_between_days = as.numeric(restoration_date - root_canal_date)
  ) %>%
  select(
    `Patient...1`,
    tooth,
    root_canal_date,
    root_canal_procedure,
    first_restoration_date = restoration_date,
    first_restoration_procedure = restoration_procedure,
    time_between_days, 
    producer
  )

endo_with_tx_time %>%
  datatable(
    extensions = 'Buttons',
    options = list(
      dom = 'Blfrtip',
      buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
      lengthMenu = list(c(10, 25, 50, -1), c(10, 25, 50, "All"))
    )
  )


```


* if a tooth has multiple restorations after root canal, keep the earliest one only. 





```{r, message=F, warning=F}
ggplot(endo_with_tx_time, aes(x = time_between_days)) +
  geom_histogram(binwidth = 5, fill = "skyblue", color = "black") +
  xlab("Time Between Days") +
  ylab("") +
  ggtitle("") +
  theme_minimal()
summary(endo_with_tx_time$time_between_days)

endo_summary <- endo_with_tx_time %>%
  mutate(time_bin = case_when(
    time_between_days == 0 ~ "0",
    time_between_days >= 1  & time_between_days <= 30   ~ "1-30",
    time_between_days >= 31 & time_between_days <= 60   ~ "31-60",
    time_between_days >= 61 & time_between_days <= 90   ~ "61-90",
    time_between_days >= 91 & time_between_days <= 120  ~ "91-120",
    time_between_days >= 121 & time_between_days <= 180 ~ "121-180",
    time_between_days > 180                            ~ "180+",
    TRUE ~ NA_character_
  )) %>%
  dplyr::count(time_bin, name = "n_tooth") %>%
  arrange(factor(time_bin, levels = c("0","1-30","31-60","61-90","91-120","121-180","180+")))
endo_summary
```









## step 3: post treatment 


```{r, message=F, warning=F}
# Create a data frame
failure_codes <- data.frame(
  Code = c("D3346", "D3347", "D3348", "D3421", "D3425", "D3410", "D3426",
           "D3430", "D3450", "D3470", "D3505", "D3920", "D7140", "D7210"),
  Description = c(
    "Anterior-retreat prev. rt. canal",
    "Bicuspid retreat prev. rt. canal",
    "Molar retreat prev. rt. canal",
    "Apicoectomy - bicuspid (1st root)",
    "Apicoectomy - molar (1st root)",
    "Apicoectomy - anterior",
    "Apicoectomy - additional roots",
    "Retrograde filling - per root",
    "Root amputation - per root",
    "Intentional reimplantation",
    "Surgical exposure of root surface w/o apicoectomy",
    "Hemisection, incl. root removal",
    "Extraction",
    "Surgical removal of erupted tooth"
  )
)


failure_codes%>%
datatable(extensions = 'Buttons',
          caption = "Extraction /failure codes", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))


```




```{r, message=F, warning=F}

# Step 1: Define the failure-related procedure codes
failure_codes <- c(
  "D3346", "D3347", "D3348", "D3421", "D3425",
  "D3410", "D3426", "D3430", "D3450", "D3470",
  "D3505", "D3920", "D7140", "D7210"
)

# Step 2: Extract only failure events from all procedures
# all_procedures must include: Patient, tooth, Date, Procedure
failure_events <- post_endo_tx %>% 
  #filter(`Endo Check`=="Yes") %>% 
  filter(Procedure %in% failure_codes) %>%
  rename(failure_date = Date, failure_code = Procedure) %>%
  select(Patient, tooth, failure_date, failure_code)

failure_events$failure_date=as.Date(failure_events$failure_date)

# Step 3: Join with endo_with_tx_time and filter for valid failures (after restoration); this step will filter some patients with failure date prior to restoration  
colnames(endo_with_tx_time)[1]="Patient"

endo_with_failure <- endo_with_tx_time %>%
  left_join(failure_events, by = c("Patient", "tooth")) %>%
  filter(is.na(failure_date) | failure_date >= first_restoration_date) %>%  # allow NA for no failure
  group_by(Patient, tooth, root_canal_date) %>%
  arrange(failure_date) %>%
  slice(1) %>%  # earliest failure (or NA)
  ungroup() %>%
  mutate(
    survival_days = as.numeric(failure_date - first_restoration_date),
    survival_weeks = round(survival_days / 7,2), 
    survival_months = round(survival_days / 30.44,2), 
    survival_years = round(survival_days / 365.25, 2)
  )

endo_with_failure%>%
datatable(extensions = 'Buttons',
          caption = "", 
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```










## survival analysis 

```{r, message=F, warning=F, eval=T}
# Load required libraries
library(survival)
library(survminer)

# Find the latest date in the dataset (from either failure or restoration dates)
last_followup_date <- max(
  c(endo_with_failure$failure_date, endo_with_failure$first_restoration_date),
  na.rm = TRUE
)

# Fill in survival_days for censored teeth
survival_data <- endo_with_failure %>%
  mutate(
    event = ifelse(is.na(failure_date), 0, 1),
    end_date = ifelse(event == 1, failure_date, last_followup_date),
    end_date = as.Date(end_date, origin = "1970-01-01"), # ensure Date type
    survival_days = as.numeric(end_date - first_restoration_date)
  )

# Step 2: Create a Surv object
surv_object <- Surv(time = survival_data$survival_days, event = survival_data$event)

# Step 3: Fit Kaplan-Meier survival model
km_fit <- survfit(surv_object ~ 1)

# Step 4: Plot Kaplan-Meier survival curve
p=ggsurvplot(
  km_fit,
  data = survival_data,  # âœ… This solves the error
  conf.int = TRUE,
  xlab = "Survival Days after restoration",
  ylab = "Tooth survival probability",
  title = "Kaplan-Meier Survival Curve of Root Canal Treated Teeth",
  surv.median.line = "hv",
  risk.table = TRUE,
  risk.table.height = 0.4, 
  break.x.by = 365,     # tick marks every year in days
  xlim = c(0, 365 * 22) # optional: show up to 10 years
)


# Custom breaks: 1, 3, 6, 9, 12, 15 years in days
year_points <- c(1,  6,  12,  18, 21)
day_breaks <- year_points * 365

p$plot <- p$plot +
  scale_x_continuous(
    breaks = day_breaks,
    labels = paste0("Year ", year_points)
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Optional: Rotate risk table labels too
p$table <- p$table +
  scale_x_continuous(
    breaks = day_breaks,
    labels = paste0("Year ", year_points)
  ) +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))

print(p)
```

* if a tooth never experiences failure/extraction, the restoration works to the end of the study 


```{r, message=F, warning=F}

# Step 1. Create event, survival_days, and time_bin
survival_data <- endo_with_failure %>%
  mutate(
    event = if_else(is.na(failure_date), 0L, 1L),  # 1 = failure, 0 = censored
    end_date = if_else(event == 1L, failure_date, last_followup_date),
    survival_days = as.numeric(end_date - first_restoration_date),
    time_bin = case_when(
      time_between_days == 0 ~ "0",
      time_between_days >= 1  & time_between_days <= 30   ~ "1-30",
      time_between_days >= 31 & time_between_days <= 60   ~ "31-60",
      time_between_days >= 61 & time_between_days <= 90   ~ "61-90",
      time_between_days >= 91 & time_between_days <= 120  ~ "91-120",
      time_between_days >= 121 & time_between_days <= 180 ~ "121-180",
      time_between_days > 180                             ~ "180+",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(time_bin), !is.na(survival_days))  # keep valid cases

survival_data <- survival_data %>%
  filter(!is.na(time_bin), !is.na(survival_days)) %>%
  mutate(time_bin = factor(
    time_bin,
    levels = c("0","1-30","31-60","61-90","91-120","121-180","180+"),
    ordered = TRUE
  ))


# Step 2. Survival object and fit by groups
surv_obj <- Surv(time = survival_data$survival_days, event = survival_data$event)
fit <- survfit(surv_obj ~ time_bin, data = survival_data)

# Step 3. Plot KM curves


p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = FALSE,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="all time points", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,       # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),  # increase legend label size, 
  break.x.by = 365,     # tick marks every year in days
  xlim = c(0, 365 * 22) # optional: show up to 10 years
)
 p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
 

p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = T,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="all time points", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,        # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),   # increase legend label size
  break.x.by = 365,     # tick marks every year in days
  xlim = c(0, 365 * 22) # optional: show up to 10 years
)
p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
```


```{r, message=F, warning=F}

# Step 1. Create event, survival_days, and time_bin
survival_data <- endo_with_failure %>% filter(survival_days>30) %>% 
  mutate(
    event = if_else(is.na(failure_date), 0L, 1L),  # 1 = failure, 0 = censored
    end_date = if_else(event == 1L, failure_date, last_followup_date),
    survival_days = as.numeric(end_date - first_restoration_date),
    time_bin = case_when(
      time_between_days == 0 ~ "0",
      time_between_days >= 1  & time_between_days <= 30   ~ "1-30",
      time_between_days >= 31 & time_between_days <= 60   ~ "31-60",
      time_between_days >= 61 & time_between_days <= 90   ~ "61-90",
      time_between_days >= 91 & time_between_days <= 120  ~ "91-120",
      time_between_days >= 121 & time_between_days <= 180 ~ "121-180",
      time_between_days > 180                             ~ "180+",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(time_bin), !is.na(survival_days))  # keep valid cases

survival_data <- survival_data %>%
  filter(!is.na(time_bin), !is.na(survival_days)) %>%
  mutate(time_bin = factor(
    time_bin,
    levels = c("0","1-30","31-60","61-90","91-120","121-180","180+"),
    ordered = TRUE
  ))


# Step 2. Survival object and fit by groups
surv_obj <- Surv(time = survival_data$survival_days, event = survival_data$event)
fit <- survfit(surv_obj ~ time_bin, data = survival_data)

# Step 3. Plot KM curves


p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = FALSE,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="remove teeth failure in one month", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,       # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),  # increase legend label size, 
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
 p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
 

p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = T,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="remove teeth failure in one month",
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,        # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),   # increase legend label size
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
```





```{r, message=F, warning=F}

# Step 1. Create event, survival_days, and time_bin
survival_data <- endo_with_failure %>% filter(grepl("^G", producer)) %>% 
  mutate(
    event = if_else(is.na(failure_date), 0L, 1L),  # 1 = failure, 0 = censored
    end_date = if_else(event == 1L, failure_date, last_followup_date),
    survival_days = as.numeric(end_date - first_restoration_date),
    time_bin = case_when(
      time_between_days == 0 ~ "0",
      time_between_days >= 1  & time_between_days <= 30   ~ "1-30",
      time_between_days >= 31 & time_between_days <= 60   ~ "31-60",
      time_between_days >= 61 & time_between_days <= 90   ~ "61-90",
      time_between_days >= 91 & time_between_days <= 120  ~ "91-120",
      time_between_days >= 121 & time_between_days <= 180 ~ "121-180",
      time_between_days > 180                             ~ "180+",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(time_bin), !is.na(survival_days))  # keep valid cases

survival_data <- survival_data %>%
  filter(!is.na(time_bin), !is.na(survival_days)) %>%
  mutate(time_bin = factor(
    time_bin,
    levels = c("0","1-30","31-60","61-90","91-120","121-180","180+"),
    ordered = TRUE
  ))


# Step 2. Survival object and fit by groups
surv_obj <- Surv(time = survival_data$survival_days, event = survival_data$event)
fit <- survfit(surv_obj ~ time_bin, data = survival_data)

# Step 3. Plot KM curves


p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = FALSE,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="producer starting with G", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,       # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),  # increase legend label size, 
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
 p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
 

p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = T,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="producer starting with G", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,        # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),   # increase legend label size
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
```



```{r, message=F, warning=F}

# Step 1. Create event, survival_days, and time_bin
survival_data <- endo_with_failure %>% filter(grepl("^S", producer)) %>% 
  mutate(
    event = if_else(is.na(failure_date), 0L, 1L),  # 1 = failure, 0 = censored
    end_date = if_else(event == 1L, failure_date, last_followup_date),
    survival_days = as.numeric(end_date - first_restoration_date),
    time_bin = case_when(
      time_between_days == 0 ~ "0",
      time_between_days >= 1  & time_between_days <= 30   ~ "1-30",
      time_between_days >= 31 & time_between_days <= 60   ~ "31-60",
      time_between_days >= 61 & time_between_days <= 90   ~ "61-90",
      time_between_days >= 91 & time_between_days <= 120  ~ "91-120",
      time_between_days >= 121 & time_between_days <= 180 ~ "121-180",
      time_between_days > 180                             ~ "180+",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(time_bin), !is.na(survival_days))  # keep valid cases

survival_data <- survival_data %>%
  filter(!is.na(time_bin), !is.na(survival_days)) %>%
  mutate(time_bin = factor(
    time_bin,
    levels = c("0","1-30","31-60","61-90","91-120","121-180","180+"),
    ordered = TRUE
  ))


# Step 2. Survival object and fit by groups
surv_obj <- Surv(time = survival_data$survival_days, event = survival_data$event)
fit <- survfit(surv_obj ~ time_bin, data = survival_data)

# Step 3. Plot KM curves


p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = FALSE,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="producer starting with S", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,       # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),  # increase legend label size, 
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
 p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
 

p=ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = T,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  title="producer starting with S", 
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,        # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14)),   # increase legend label size
  break.x.by = 30,     # tick marks every year in days
  xlim = c(0, 365) # optional: show up to 10 years
)
p$plot=p$plot+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p$table=p$table+theme(axis.text.x = element_text(angle = 45, hjust = 1))
 p
```





```{r, message=F, warning=F}

# Step 1. Create event, survival_days, and time_bin
survival_data <- endo_with_failure %>%
  mutate(
    event = if_else(is.na(failure_date), 0L, 1L),  # 1 = failure, 0 = censored
    end_date = if_else(event == 1L, failure_date, last_followup_date),
    survival_days = as.numeric(end_date - first_restoration_date),
    time_bin = case_when(
     time_between_days <= 60   ~ "0-60",
      time_between_days >= 61 & time_between_days <= 120   ~ "61-120",
      time_between_days >= 121  ~ "120+",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(time_bin), !is.na(survival_days))  # keep valid cases

survival_data <- survival_data %>%
  filter(!is.na(time_bin), !is.na(survival_days)) %>%
  mutate(time_bin = factor(
    time_bin,
    levels = c("0-60","61-120","120+"),
    ordered = TRUE
  ))


# Step 2. Survival object and fit by groups
surv_obj <- Surv(time = survival_data$survival_days, event = survival_data$event)
fit <- survfit(surv_obj ~ time_bin, data = survival_data)

# Step 3. Plot KM curves


ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = FALSE,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,       # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14))  # increase legend label size
)

ggsurvplot(
  fit,
  data = survival_data,
  pval = TRUE,
  risk.table = TRUE,
  risk.table.height=0.4,
  conf.int = T,          # remove confidence band
  legend.title = NULL,
  legend.labs = gsub("time_bin=", "", names(fit$strata)),
  risk.table.fontsize = 3,
  xlab = "Survival days after restoration",
  ylab = "Survival probability",
  linetype = 1,              # solid lines
  size = 1,                  # line width
  surv.median.line = "none", # remove median line
  #censor.shape = "|",        # show censoring
  censor.size = 2,             # small censor marks
  censor.shape = NA,        # <-- hide the vertical censoring ticks
  ggtheme = theme_minimal(base_size = 12) +   # base font size
    theme(legend.text = element_text(size = 14))  # increase legend label size
)
```
