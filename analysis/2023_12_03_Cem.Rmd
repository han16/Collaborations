---
title: "12/18/2023"
output: html_document
date: "2023-12-18"
---

```{r, echo=F, message=F, warning=F, results=F}
source("C:/Shengtong/Research/AllCollaboration/Collaborations/analysis/Rfunctions.R")
data_raw=multiplesheets("C:\\Shengtong\\Research\\AllCollaboration\\2023\\202310\\Cem\\Dr Han Excel workbook-Hall SSC study_20240116.xlsx")
data=as_tibble(data_raw[[1]])
```


## survival analysis of SSCs 

### basic numbers 

```{r, echo=F, message=F, warning=F}
data_ssc_survival=data %>% filter(`SSC Placement Technique`==1 | `SSC Placement Technique`==2 ) %>% select(`SSC Placement Technique`, `6-month`, `12-month`, `18-month`, `24-month`, `30-month`, `36-month`, `42-month`, `48-month`, `54-month`, `60-month`, `66-month`, `Age on Tx Date`, `Behavior`, `Tx. Site`, `Tx Provider`)  # only include TT, HT two methods 

time_point=c("6-month", "12-month", "18-month", "24-month", "30-month", "36-month", "42-month", "48-month", "54-month", "60-month", "66-month")
#time_point=seq(6,66,by=6)

TT=numeric()
HT=numeric()
for (i in 1:length(time_point))
{
  TT[i]=sum(data_ssc_survival %>% filter(`SSC Placement Technique`==1) %>% select(time_point[i]) %>% pull()==1) # count survivors at every time point  
  HT[i]=sum(data_ssc_survival %>% filter(`SSC Placement Technique`==2) %>% select(time_point[i]) %>% pull()==1)
}
time_point[1]="06-month"
TT_HT=data.frame(num_success=c(TT, HT), time_point= rep(time_point,2), technique=c(rep("TT", length(time_point)), rep("HT", length(time_point))))

ggplot(data = TT_HT, aes(x = time_point, y = num_success, fill = technique)) +
  geom_bar(stat = "identity", position = position_dodge(), alpha = 0.75)  +
  ylim(0,400) +
  geom_text(aes(label = num_success), fontface = "bold", vjust = 1.5, 
             position = position_dodge(.9), size = 4) +
  labs(x = "\n time ", y = "#. success:SSC=1\n", title = "\n  \n") +
  theme(plot.title = element_text(hjust = 0.5), 
        axis.title.x = element_text(face="bold", colour="red", size = 12),
        axis.title.y = element_text(face="bold", colour="red", size = 12),
        legend.title = element_text(face="bold", size = 10))+
   theme(axis.text.x = element_text(angle = 45, vjust = 1, 
    size = 12, hjust = 1))

```
* only include HT and TT 

* numbers are for teeth, not patients and one patient may have multiple teeth 



## teeth age between TT and HT 

```{r, echo=T, message=F, warning=F}
sample1=data_ssc_survival %>% filter(`SSC Placement Technique`==1) %>% select(`Age on Tx Date`) %>% pull()
sample2=data_ssc_survival %>% filter(`SSC Placement Technique`==2) %>% select(`Age on Tx Date`) %>% pull()
t.test(sample1, sample2)
```

* teeth age between two techniques. 



## teeth behavior score between TT and HT

```{r, echo=F, message=F, warning=F}
TT_behavior=data_ssc_survival %>% filter(`SSC Placement Technique`==1) %>% select(Behavior)%>% dplyr::count(Behavior)
HT_behavior=data_ssc_survival %>% filter(`SSC Placement Technique`==2) %>% select(Behavior)%>% dplyr::count(Behavior)
TT_HT_behavior=data.frame(TT=TT_behavior$n, HT=HT_behavior$n)
```


```{r, echo=F, message=F, warning=F}
library("gplots")
# 1. convert the data as a table
dt <- as.table(as.matrix(TT_HT_behavior))
rownames(dt)=TT_behavior$Behavior
# 2. Graph
balloonplot(t(dt), main ="Behavior", xlab ="", ylab="",
            label = FALSE, show.margins = FALSE)


library("graphics")
mosaicplot(dt, shade = TRUE, las=2,
           main = "Behavior")
```




* Blue color indicates that the observed value is higher than the expected value if the data were random

* Red color specifies that the observed value is lower than the expected value if the data were random

* [reference](http://www.sthda.com/english/wiki/chi-square-test-of-independence-in-r)



```{r, echo=T, message=F, warning=F}
chisq=chisq.test(TT_HT_behavior)
chisq
chisq$observed
round(chisq$expected,2)
```

* small p value suggests teeth behavior differ between TT and HT 


### Kaplan-Meier survival analyses 

```{r, echo=F, message=F, warning=F}
library(survival)


######## compute survival time for every tooth 
survival_time=numeric(); status=numeric()
num_ones=numeric(); num_threes=numeric();num_zeros=numeric() 
for (i in 1:nrow(data_ssc_survival))
{
  num_ones[i]=sum(as.numeric(data_ssc_survival[i,2:12])==1)
  if (as.numeric(data_ssc_survival[i,num_ones[i]+2])==2)  # 1--->2
   survival_time[i]=(num_ones[i]+1)*6 # survival time in months 
  
  if (as.numeric(data_ssc_survival[i,num_ones[i]+2])==3)  # 1--->3
  {
    num_threes[i]=sum(as.numeric(data_ssc_survival[i,2:12])==3)
    survival_time[i]=(num_ones[i]+num_threes[i]+1)*6 # survival time in months
  }
  
  if (as.numeric(data_ssc_survival[i,num_ones[i]+2])==0)  # 1--->0
     survival_time[i]=(num_ones[i]+1)*6 # survival time in months
  
  num_zeros[i]=sum(as.numeric(data_ssc_survival[i,2:12])==0)
  if (num_zeros[i]>0) # there is drop off
    status[i]=0
  if (num_zeros[i]==0) # no drop off, i.e. observed data
    status[i]=1
  
}

data_ssc_survival_complete=data_ssc_survival %>% add_column(survival_time=survival_time, status=status) %>% drop_na()  
colnames(data_ssc_survival_complete)[1]="SSC_Placement_Technique"


s1 <- survfit(Surv(survival_time, status) ~ 1, data = data_ssc_survival_complete)
str(s1)
summary(s1)


survfit2(Surv(survival_time, status) ~ 1, data = data_ssc_survival_complete) %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability of teeth"
  ) + 
  add_confidence_interval()+
  add_risktable()


survfit2(Surv(survival_time, status) ~ SSC_Placement_Technique, data = data_ssc_survival_complete) %>% 
  ggsurvfit() +
  labs(
    x = "Months",
    y = "Overall survival probability of teeth"
  ) +
  add_confidence_interval()+
  add_risktable()

```
 

* [reference](https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html)

* `TT:SSC_Placement_Technique=1` vs `HT:SSC_Placement_Technique=2`

* `At Risk: No. survivals`, `Events: No.failures`




#### Logrank test between two samples 


```{r, echo=F, message=F, warning=F}
 # comparing survival time between groups
survdiff(Surv(survival_time, status) ~ SSC_Placement_Technique, data = data_ssc_survival_complete)
```
* large p value indicates no statistical difference in survival time between TT and HT  


## covariate effect on survival of SSCs

```{r, echo=F, message=F, warning=F}
coxph(Surv(survival_time, status) ~ `Age on Tx Date`, data = data_ssc_survival_complete)%>% 
  tbl_regression(exp = TRUE) 
```

* one increase unit of age leads to 1% increase of hazard of failure.  (hazard: the probability of experiencing an event, e.g. death)

* use cox regression 



```{r, echo=F, message=F, warning=F}
coxph(Surv(survival_time, status) ~ `Tx. Site`, data = data_ssc_survival_complete)%>% 
  tbl_regression(exp = TRUE) 
```


* `A is the reference`, all other sites comparing to the reference

* HR < indicates reduced hazard and HR>1 increased hazard. 


```{r, echo=F, message=F, warning=F}
coxph(Surv(survival_time, status) ~ `SSC_Placement_Technique`, data = data_ssc_survival_complete)%>% 
  tbl_regression(exp = TRUE) 
```

* hazard ratio of HT (2) vs TT (1) is 1.34 




```{r, echo=F, message=F, warning=F}
coxph(Surv(survival_time, status) ~ as.factor(Behavior), data = data_ssc_survival_complete)%>% 
  tbl_regression(exp = TRUE) 
```


* `Frankl 1				: 1` is the reference 



```{r, echo=F, message=F, warning=F}
coxph(Surv(survival_time, status) ~ as.factor(`Tx Provider`), data = data_ssc_survival_complete)%>% 
  tbl_regression(exp = TRUE) 
```


* `D3				: 1` is the reference group 



## the effect of the SSC placement technique (TT vs. HT) on the need to use advanced behavior management and on the patients’ behavior scores  ? 



## analyze the effect of patient’s age and behavior score on the number of SSCs received by the patient at the same appointment









