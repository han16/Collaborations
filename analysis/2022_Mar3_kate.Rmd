---
title: "3/29/2022"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr) # combine and arrange multiple 
library(kableExtra)
library(rstatix) # use anova_test function 
set.seed(123)
```

```{r, echo=F, echo=F, message=F}
#data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\FullDataSAI.csv", header=T))

data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\June_2022_Final_Data.csv", header=T)) # this is newly corrected data

#data %>% mutate(average_number_prior=PBI.Total.Screening/Number.of.Sites, average_number_post=PBI.Total.8.wk/Number.of.Sites)
```



## PBI (papillary bleeding index)

### trajectory plot 

* measurements are taken at 2 time points, `PBI.Screening`, `PBI.8.wk`, and are longitudinal data 

```{r, echo=F, message=F, warning=F}
#data_long=data.frame(PBI=c(data$PBI.Screening, data$PBI.8.wk), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(seq(1, nrow(data)),2))

data_long=data.frame(PBI_total=c(data$PBI.Total.Screening, data$PBI.Total.8.wk), PBI_average=c(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(data$Patient.ID.Number,2))

g1=ggplot(data=data_long,aes(x=time, y=PBI_total, group=individual))+
  geom_line(color="red")+
  geom_point() # look at total PBI 


g2=ggplot(data.frame(PBI_mean=c(mean(data$PBI.Total.Screening),mean(data$PBI.Total.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.Total.8.wk, data$PBI.Total.Screening), max(data$PBI.Total.8.wk, data$PBI.Total.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure 
```



```{r, echo=F, message=F, warning=F}

g1=ggplot(data=data_long,aes(x=time, y=PBI_average, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_average_mean=c(mean(data$Average.PBI.Score.Pre.TX),mean(data$Average.PBI.Score.8.week)), time=c("screening", "week 8")), aes(x=time, y=PBI_average_mean, group=1))+
  ylim(c(min(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week), max(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure 
```



### summary statistics 

```{r, echo=F, message=F, warning=F}
data_long %>%
  group_by(time) %>%
  get_summary_stats(PBI_total, type = "mean_sd")
```

```{r, echo=F, message=F, warning=F}
data_long %>%
  group_by(time) %>%
  get_summary_stats(PBI_average, type = "mean_sd")
```


### boxplot 


```{r, echo=F, warning=F, message=F}
bxp <- ggboxplot(data_long, x = "time", y = "PBI_total", add = "point")
bxp

bxp <- ggboxplot(data_long, x = "time", y = "PBI_average", add = "point")
bxp
```

### outlier detection 



```{r, echo=F, message=F, warning=F}
data_long %>% 
  group_by(time) %>% 
  identify_outliers(PBI_total)

data_long %>% 
  group_by(time) %>% 
  identify_outliers(PBI_average)
```

### normality assumption 

```{r, echo=F, message=F, warning=F}
data_long %>% group_by(time) %>% shapiro_test(PBI_total)
data_long %>% group_by(time) %>% shapiro_test(PBI_average)
```

* all p values are bigger than 0.05, suggesting they are normally distributed. 

```{r, echo=F, message=F, warning=F}
ggqqplot(data_long, "PBI_total", facet.by="time")

ggqqplot(data_long, "PBI_average", facet.by="time")
```


* most points fall along reference line, normality assumption is reasonable. 





```{r, echo=F, message=F, warning=F}
res.aov <- anova_test(data = data_long, dv = PBI_total, wid = individual, within = time)
get_anova_table(res.aov)

res.aov <- anova_test(data = data_long, dv = PBI_average, wid = individual, within = time)
get_anova_table(res.aov)
```
 * [anova_test](https://search.r-project.org/CRAN/refmans/rstatix/html/anova_test.html) repeated measures ANOVA 
 
 * PBI: dependent variable 
 
 * PIB are statistical different between screening and week 8 by small p value of 0.017. 
 
 
 
```{r, echo=F, message=F, warning=F}
pwc=data_long %>% pairwise_t_test(PBI_total ~ time, paired=T, p.adjust.method = "bonferroni")
pwc=pwc %>%add_xy_position(x="time")

bxp+
  stat_pvalue_manual(pwc)+
  labs(subtitle=get_test_label(res.aov, detailed = T), caption=get_pwc_label(pwc))

```
 
 
```{r, echo=F, message=F, warning=F}
pwc=data_long %>% pairwise_t_test(PBI_average ~ time, paired=T, p.adjust.method = "bonferroni")
pwc=pwc %>%add_xy_position(x="time")

bxp+
  stat_pvalue_manual(pwc)+
  labs(subtitle=get_test_label(res.aov, detailed = T), caption=get_pwc_label(pwc))

```


## 3 clusters 


```{r, echo=F, message=F, warning=F, eval=T}
PBI_group1=data%>%filter(Average.PBI.Score.8.week <2 ) %>% select(Patient.ID.Number) %>% pull
PBI_group2=data%>%filter( Average.PBI.Score.8.week >=2 ) %>% select(Patient.ID.Number) %>% pull
PBI_group3=data%>%filter( Average.PBI.Score.8.week >3 ) %>% select(Patient.ID.Number) %>% pull

data_long_group1=data_long%>%filter(individual %in% PBI_group1==T)
data_long_group2=data_long%>%filter(individual %in% PBI_group2==T)
data_long_group3=data_long%>%filter(individual %in% PBI_group3==T)
data.frame(group=c("PBI <2 post-treatment", "PBI>=2 post-treatment", "PBI >3 post-treatment"), num_individual=c(nrow(data_long_group1)/2, nrow(data_long_group2)/2, nrow(data_long_group3)/2))
```



## difference at week 8 

```{r, echo=F, message=F, warning=F}
covariates=c("SAI", "sRDI", "SQI", "Fragmentation", "Cortisol.1", "Cortisol.2", "Cortisol.3", "Cortisol.4", "Total.Cortisol", "BMI.kg.m2")
pvalue=numeric()
for (i in 1:length(covariates))
{
  group1=as.numeric(data%>%filter(Average.PBI.Score.8.week<2) %>% select(covariates[i]) %>% pull())
  group1=group1[!is.na(group1)] # remove na's 
  
  group2=as.numeric(data%>%filter(Average.PBI.Score.8.week>=2) %>% select(covariates[i]) %>% pull())
  group2=group2[!is.na(group2)]
  
  two.sample.ttest=t.test(group1, group2)
  pvalue[i]=two.sample.ttest$p.value
}
data.frame(covariates=covariates, pvalue=pvalue)
```

* compare PBI <2 post-treatment vs PBI >=2 post-treatment at week 8 
* two sample t test is used 




```{r, echo=F, message=F, warning=F, eval=F}
g1=ggplot(data=data_long_increase,aes(x=time, y=PBI, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_mean=c(mean(data[data$Patient.ID.Number%in% PBI_increase_indi, ]$PBI.Screening),mean(data[data$Patient.ID.Number%in% PBI_increase_indi,]$PBI.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.8.wk, data$PBI.Screening), max(data$PBI.8.wk, data$PBI.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure
############################
data_long_increase %>%
  group_by(time) %>%
  get_summary_stats(PBI, type = "mean_sd")
###########################
res.aov <- anova_test(data = data_long_increase, dv = PBI, wid = individual, within = time)

get_anova_table(res.aov)
```


```{r, echo=F, message=F, warning=F, eval=F}
g1=ggplot(data=data_long_decrease,aes(x=time, y=PBI, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_mean=c(mean(data[data$Patient.ID.Number%in% PBI_decrease_indi, ]$PBI.Screening),mean(data[data$Patient.ID.Number%in% PBI_decrease_indi,]$PBI.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.8.wk, data$PBI.Screening), max(data$PBI.8.wk, data$PBI.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure
############################
data_long_decrease %>%
  group_by(time) %>%
  get_summary_stats(PBI, type = "mean_sd")
###########################
res.aov <- anova_test(data = data_long_decrease, dv = PBI, wid = individual, within = time)

get_anova_table(res.aov)
```


## Cortisol 

```{r, echo=F, message=F, warning=F}
data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\June_2022_Final_Data.csv", header=T)) # this is newly corrected data

data=data %>% mutate(Cortisol.1_normalized=(Cortisol.1-mean(Cortisol.1))/sd(Cortisol.1)) %>% mutate(Cortisol.2_normalized=(Cortisol.2-mean(Cortisol.2))/sd(Cortisol.2))  %>% mutate(Cortisol.3_normalized=(Cortisol.3-mean(Cortisol.3))/sd(Cortisol.3)) #%>% mutate(Cortisol.4_normalized=(Cortisol.4-mean(Cortisol.4))/sd(Cortisol.4))
Cortisol.4=as.numeric(data$Cortisol.4) # convert to numeric values 
Cortisol.4[is.na(Cortisol.4)] <- 0 # replace NA with 0 

data=data %>% add_column(Cortisol.4_normalized=(Cortisol.4-mean(Cortisol.4))/sd(Cortisol.4))

data_Cortisol=data %>% select(Patient.ID.Number,Cortisol.1_normalized, Cortisol.2_normalized, Cortisol.3_normalized, Cortisol.4_normalized) 

data_Cortisol=data_Cortisol %>% add_column(Cortisol.1=data$Cortisol.1, Cortisol.2=data$Cortisol.2,Cortisol.3=data$Cortisol.3,Cortisol.4=Cortisol.4)

data_Cortisol_long=data.frame(Patient.ID.Number=c(data_Cortisol$Patient.ID.Number, data_Cortisol$Patient.ID.Number, data_Cortisol$Patient.ID.Number, data_Cortisol$Patient.ID.Number), Cortisol=c(data_Cortisol$Cortisol.1_normalized, data_Cortisol$Cortisol.2_normalized, data_Cortisol$Cortisol.3_normalized, data_Cortisol$Cortisol.4_normalized), time=rep(c("Cortisol.1", "Cortisol.2", "Cortisol.3", "Cortisol.4"), each=102))

g1=ggplot(data=data_Cortisol_long %>% filter(Patient.ID.Number %in% PBI_group1),aes(x=time, y=Cortisol, group=Patient.ID.Number))+
  geom_line(color="red")+
  geom_point()+
  ggtitle("PBI_week8<2")


g2=ggplot(data=data_Cortisol_long %>% filter(Patient.ID.Number %in% PBI_group2),aes(x=time, y=Cortisol, group=Patient.ID.Number))+
  geom_line(color="red")+
  geom_point()+
  ggtitle("PBI_week8>=2")

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure
```


### individual C.1, C.2, C.3, C.4



| \      | C.1 |   C.2    | C.3 | C.4 | 
| :---        |    :----:   |          ---: |       ---:  |       ---:  |          
| p value       | 0.189      | 0.165  |    0.034         |  0.006           |   




```{r, echo=F, message=F, warning=F}

#### C.1
group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.1_normalized) %>% pull 

group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.1_normalized) %>% pull

two_sample_ttest=t.test(group1, group2)

```


```{r, echo=F, message=F, warning=F}
#### C.2 

group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2_normalized) %>% pull 

group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2_normalized) %>% pull

two_sample_ttest=t.test(group1, group2)

```


```{r, echo=F, message=F, warning=F}
#### C.3 
group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3_normalized) %>% pull 

group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3_normalized) %>% pull

two_sample_ttest=t.test(group1, group2)


```


```{r, echo=F, message=F, warning=F}
#### C.4
group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.4_normalized) %>% pull 

group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.4_normalized) %>% pull

two_sample_ttest=t.test(group1, group2)

```


#### normal vs abnormal at each C.i

```{r, echo=F, warning=F, message=F}
knitr::kable(data_Cortisol %>% filter(Cortisol.1>=5.1 & Cortisol.1<=11.1) %>% select(Patient.ID.Number, Cortisol.1), caption = "C.1 (5.1 - 11.1) ")%>%
kable_styling() %>%
scroll_box(height = "300px")
```

```{r, echo=F, warning=F, message=F}
knitr::kable(data_Cortisol %>% filter(Cortisol.2>=2.3 & Cortisol.2<=5.3) %>% select(Patient.ID.Number, Cortisol.2), caption = "C.2 (2.3 - 5.3) ")%>%
kable_styling() %>%
scroll_box(height = "300px")
```

```{r, echo=F, warning=F, message=F}
knitr::kable(data_Cortisol %>% filter(Cortisol.3>=1.0 & Cortisol.3<=2.4) %>% select(Patient.ID.Number, Cortisol.3), caption = "C.3 (1.0 - 2.4) ")%>%
kable_styling() %>%
scroll_box(height = "300px")
```

```{r, echo=F, warning=F, message=F}
knitr::kable(data_Cortisol %>% filter(Cortisol.4>=0.4 & Cortisol.4<=2.1) %>% select(Patient.ID.Number, Cortisol.4), caption = "C.4 (0.4 - 2.1) ")%>%
kable_styling() %>%
scroll_box(height = "300px")
```


```{r, echo=F, warning=F, message=F}
knitr::kable(data_Cortisol %>% filter(Cortisol.1>=5.1 & Cortisol.1<=11.6 & Cortisol.2>=2.3 & Cortisol.2<=5.3 & Cortisol.3>=1.0 & Cortisol.3<=2.4 & Cortisol.4>=0.4 & Cortisol.4<=2.1) %>% select(Patient.ID.Number, Cortisol.1, Cortisol.2, Cortisol.3, Cortisol.4), caption = "C.1 (5.1 - 11.1) & C.2 (2.3 - 5.3) & C.3 (1.0 - 2.4) & C.4 (0.4 - 2.1)")%>%
kable_styling() %>%
scroll_box(height = "300px")
```



individuals in normal and abnormal group  

| \      | C.1 (5.1 - 11.1) |   C.2 (2.3 - 5.3)    | C.3 (1.0 - 2.4) | C.4 (0.4 - 2.1) | 
| :---        |    :----:   |          ---: |       ---:  |       ---:  |          
| normal      | 50      | 69  |    46         |  81          |   
| abnormal    | 72      | 33  |    56         |  21           | 


there are 14 individuals with normal cortisols across 4 timepoints. 



### C.i-->C.i+1


| \      | C.1-->C.2 |   C.2-->C.3    | C.3-->C.4 | 
| :---        |    :----:   |          ---: |       ---:  |                
| p value       | 0.939      | 0.486  |    0.800         |  




```{r, echo=F, message=F, warning=F}
### `C.1-->C.2`
diff_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.1_normalized) 

diff_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.1_normalized)

two_sample_ttest=t.test(diff_group1, diff_group2)


```



```{r, echo=F, message=F, warning=F}
### `C.2-->C.3`
diff_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2_normalized) 

diff_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2_normalized)

two_sample_ttest=t.test(diff_group1, diff_group2)


```




```{r, echo=F, message=F, warning=F}
### `C.3-->C.4`
diff_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.4_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3_normalized) 

diff_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.4_normalized) %>% pull-data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3_normalized)

two_sample_ttest=t.test(diff_group1, diff_group2)


```

* first calculate Z scores for cortisol 

* then use two sample t test to compare the change difference between two groups PBI <=2 post-treatment vs PBI >2 post-treatment. 


### C.i+1/C.i for normalized cortisol 



| \      | C.2/C.1 |   C.3/C.2    | C.4/C.3 | 
| :---        |    :----:   |          ---: |       ---:  |                
| p value       | 0.347      | 0.149  |    0.136         |  


```{r, echo=F, message=F, warning=F}
### `C.2/C.1`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.1_normalized) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.1_normalized) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```






```{r, echo=F, message=F, warning=F}
### `C.3/C.2`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2_normalized) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2_normalized) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```

```{r, echo=F, message=F, warning=F}
### `C.4/C.3`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.4_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3_normalized) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.4_normalized) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3_normalized) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```


* first calculate Z scores for cortisol 
* compute the ratio of C.i+1/C.i, this ratio could be negative due to normalization step 

* then use two sample t test to compare the change ratio between two groups PBI <2 post-treatment vs PBI >=2 post-treatment. 


### C.i+1/C.i for raw cortisol 



| \      | C.2/C.1 |   C.3/C.2    | C.4/C.3 | 
| :---        |    :----:   |          ---: |       ---:  |                
| p value       | 0.725      | 0.228  |    0.006         |  


```{r, echo=F, message=F, warning=F}
### `C.2/C.1`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.1) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.1) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```


```{r, echo=F, message=F, warning=F}
### `C.3/C.2`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.2) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.2) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```


```{r, echo=F, message=F, warning=F}
### `C.4/C.3`
ratio_group1=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.4) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group1) %>% select(Cortisol.3) %>% pull 

ratio_group2=data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.4) %>% pull/data_Cortisol %>% filter(Patient.ID.Number %in% PBI_group2) %>% select(Cortisol.3) %>% pull

two_sample_ttest=t.test(ratio_group1, ratio_group2)


```

* compute the ratio of C.i+1/C.i for raw data, a number between 0 and 1. 

* then use two sample t test to compare the change ratio between two groups PBI <2 post-treatment vs PBI >=2 post-treatment. 



#### relevant studies 

* [Salivary cortisol as a diagnostic tool for Cushing's syndrome and adrenal insufficiency: improved screening by an automatic immunoassay](https://eje.bioscientifica.com/view/journals/eje/166/4/613.xml)


* [Association of Diurnal Patterns in Salivary Cortisol with All-Cause and Cardiovascular Mortality: Findings from the Whitehall II Study](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3085201/)

* [Area under the curve and other summary indicators of repeated waking cortisol measurements](https://pubmed.ncbi.nlm.nih.gov/17766693/)




### Response profile analysis 

 [Response profile analysis](https://content.sph.harvard.edu/fitzmaur/ala2e/)


```{r, echo=F, message=F, warning=F}
library(foreign)
############ prepare the data 
Patient.ID.Number=data_Cortisol$Patient.ID.Number
trt=Patient.ID.Number
trt[trt%in%PBI_group1]="group1"
trt[trt%in%PBI_group2]="group2"
trt=factor(trt)

data_Cortisol_update=data.frame(id=Patient.ID.Number, treatment=trt, y0=data_Cortisol$Cortisol.1_normalized, y1=data_Cortisol$Cortisol.2_normalized, y2=data_Cortisol$Cortisol.3_normalized, y3=data_Cortisol$Cortisol.4_normalized)

######## convert into long format 
data_Cortisol_update_long <- reshape(data_Cortisol_update, idvar="id", varying=c("y0","y1","y2","y3"), v.names="y", timevar="time", time=1:4, direction="long")
attach(data_Cortisol_update_long) # when attaching variables, DO not use same variable names multiple times 

######### plot mean curve 
interaction.plot(time, treatment, y, type="b", pch=c(19,21), xlab="Time", ylab="Cortisol", main="", col=c(2,4))



library(nlme)
model <- gls(y ~ treatment*time, corr=corSymm(, form= ~ time | id), weights = varIdent(form = ~ 1 | time))
summary(model)

 anova(model)
```


* p value of 0.3702 for treatment X time interaction indicates lack of interaction. 


## Figues 

### Figure 3 

```{r, echo=F, warning=F, message=F}
num_participants=numeric()
average_sAHI=numeric()
num_participants[1]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=0 & Epworth.Score<=5) %>%nrow 
average_sAHI[1]=mean(data%>%filter(Patient.ID.Number>=40 &Epworth.Score>=0 & Epworth.Score<=5) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[2]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=6 & Epworth.Score<=10) %>%nrow 
average_sAHI[2]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=6 & Epworth.Score<=10) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[3]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=11 & Epworth.Score<=12) %>%nrow 
average_sAHI[3]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=11 & Epworth.Score<=12) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[4]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=13 & Epworth.Score<=15) %>%nrow 
average_sAHI[4]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=13 & Epworth.Score<=15) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[5]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=16 & Epworth.Score<=24) %>%nrow 
average_sAHI[5]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=16 & Epworth.Score<=24) %>% select(sAHI) %>% pull, na.rm=T)

knitr::kable(data.frame(Epworth_score=c("0-5", "6-10", "11-12", "13-15", "16-24"), sleepiness_severity=c("lower normal", "higher normal", "mild excessive", "moderate excessive", "severe"), num_participants=num_participants, Average_sAHI=round(average_sAHI,2)), "pipe")

```

* ID>=40
* boundary value are included, e.g. `Epworth.Score>=0 & Epworth.Score<=5`

### Figure 4

```{r, echo=F, warning=F, message=F}
num_participants=numeric()
average_sAHI=numeric()
num_participants[1]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=0 & Epworth.Score<=5 & sAHI>=5) %>%nrow 
average_sAHI[1]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=0 & Epworth.Score<=5 & sAHI>=5) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[2]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=6 & Epworth.Score<=10 & sAHI>=5) %>%nrow 
average_sAHI[2]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=6 & Epworth.Score<=10 & sAHI>=5) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[3]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=11 & Epworth.Score<=12 & sAHI>=5) %>%nrow 
average_sAHI[3]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=11 & Epworth.Score<=12 & sAHI>=5) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[4]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=13 & Epworth.Score<=15 & sAHI>=5) %>%nrow 
average_sAHI[4]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=13 & Epworth.Score<=15 & sAHI>=5) %>% select(sAHI) %>% pull, na.rm=T)

num_participants[5]=data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=16 & Epworth.Score<=24 & sAHI>=5) %>%nrow 
average_sAHI[5]=mean(data%>%filter(Patient.ID.Number>=40 & Epworth.Score>=16 & Epworth.Score<=24 & sAHI>=5) %>% select(sAHI) %>% pull, na.rm=T)

knitr::kable(data.frame(Epworth_score=c("0-5", "6-10", "11-12", "13-15", "16-24"), sleepiness_severity=c("lower normal", "higher normal", "mild excessive", "moderate excessive", "severe"), num_participants_sAHI_larger_than5=num_participants, Average_sAHI=round(average_sAHI,2)), "pipe")

```
* ID>=40
* boundary value are included


### Fgure 6 



```{r, echo=F, warning=F, message=F}
num_participants=numeric()
average_BMI=numeric()
num_participants[1]=data%>%filter(Patient.ID.Number>=40 ) %>%nrow 
average_BMI[1]=mean(data%>%filter(Patient.ID.Number>=40) %>% select(BMI.kg.m2) %>% pull, na.rm=T)

num_participants[2]=data%>%filter(Patient.ID.Number>=40 & sAHI<5) %>%nrow 
average_BMI[2]=mean(data%>%filter(Patient.ID.Number>=40 & sAHI<5) %>% select(BMI.kg.m2) %>% pull, na.rm=T)

num_participants[3]=data%>%filter(Patient.ID.Number>=40 & sAHI>=5) %>%nrow 
average_BMI[3]=mean(data%>%filter(Patient.ID.Number>=40 & sAHI>=5) %>% select(BMI.kg.m2) %>% pull, na.rm=T)

num_participants[4]=data%>%filter(Patient.ID.Number>=40 & sAHI>=15) %>%nrow 
average_BMI[4]=mean(data%>%filter(Patient.ID.Number>=40 & sAHI>=15) %>% select(BMI.kg.m2) %>% pull, na.rm=T)

knitr::kable(data.frame(Epworth_score=c(" all participants", "sAHI<5", "sAHI>=5", "sAHI>=15"), num_participants=num_participants, Average_BMI=round(average_BMI,2)), "pipe")

```

## statistical software 

```{r, echo=F}
R.version
```

