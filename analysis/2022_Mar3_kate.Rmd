---
title: "3/29/2022"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr) # combine and arrange multiple 
library(rstatix) # use anova_test function 
set.seed(123)
```

```{r, echo=F, echo=F, message=F}
#data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\FullDataSAI.csv", header=T))

data=as_tibble(read.csv("C:\\Shengtong\\Research\\AllCollaboration\\2022\\202203\\Kate\\June_2022_Final_Data.csv", header=T)) # this is newly corrected data

#data %>% mutate(average_number_prior=PBI.Total.Screening/Number.of.Sites, average_number_post=PBI.Total.8.wk/Number.of.Sites)
```



## PBI (papillary bleeding index)

### trajectory plot 

* measurements are taken at 2 time points, `PBI.Screening`, `PBI.8.wk`, and are longitudinal data 

```{r, echo=F, message=F, warning=F}
#data_long=data.frame(PBI=c(data$PBI.Screening, data$PBI.8.wk), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(seq(1, nrow(data)),2))

data_long=data.frame(PBI_total=c(data$PBI.Total.Screening, data$PBI.Total.8.wk), PBI_average=c(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week), time=rep(c("screening", "week 8"), each=nrow(data)), individual=rep(data$Patient.ID.Number,2))

g1=ggplot(data=data_long,aes(x=time, y=PBI_total, group=individual))+
  geom_line(color="red")+
  geom_point() # look at total PBI 


g2=ggplot(data.frame(PBI_mean=c(mean(data$PBI.Total.Screening),mean(data$PBI.Total.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.Total.8.wk, data$PBI.Total.Screening), max(data$PBI.Total.8.wk, data$PBI.Total.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure 
```



```{r, echo=F, message=F, warning=F}

g1=ggplot(data=data_long,aes(x=time, y=PBI_average, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_average_mean=c(mean(data$Average.PBI.Score.Pre.TX),mean(data$Average.PBI.Score.8.week)), time=c("screening", "week 8")), aes(x=time, y=PBI_average_mean, group=1))+
  ylim(c(min(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week), max(data$Average.PBI.Score.Pre.TX, data$Average.PBI.Score.8.week)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure 
```



### summary statistics 

```{r, echo=F, message=F, warning=F}
data_long %>%
  group_by(time) %>%
  get_summary_stats(PBI_total, type = "mean_sd")
```

```{r, echo=F, message=F, warning=F}
data_long %>%
  group_by(time) %>%
  get_summary_stats(PBI_average, type = "mean_sd")
```


### boxplot 


```{r, echo=F, warning=F, message=F}
bxp <- ggboxplot(data_long, x = "time", y = "PBI_total", add = "point")
bxp

bxp <- ggboxplot(data_long, x = "time", y = "PBI_average", add = "point")
bxp
```

### outlier detection 



```{r, echo=F, message=F, warning=F}
data_long %>% 
  group_by(time) %>% 
  identify_outliers(PBI_total)

data_long %>% 
  group_by(time) %>% 
  identify_outliers(PBI_average)
```

### normality assumption 

```{r, echo=F, message=F, warning=F}
data_long %>% group_by(time) %>% shapiro_test(PBI_total)
data_long %>% group_by(time) %>% shapiro_test(PBI_average)
```

* all p values are bigger than 0.05, suggesting they are normally distributed. 

```{r, echo=F, message=F, warning=F}
ggqqplot(data_long, "PBI_total", facet.by="time")

ggqqplot(data_long, "PBI_average", facet.by="time")
```


* most points fall along reference line, normality assumption is reasonable. 





```{r, echo=F, message=F, warning=F}
res.aov <- anova_test(data = data_long, dv = PBI_total, wid = individual, within = time)
get_anova_table(res.aov)

res.aov <- anova_test(data = data_long, dv = PBI_average, wid = individual, within = time)
get_anova_table(res.aov)
```
 * [anova_test](https://search.r-project.org/CRAN/refmans/rstatix/html/anova_test.html) repeated measures ANOVA 
 
 * PBI: dependent variable 
 
 * PIB are statistical different between screening and week 8 by small p value of 0.017. 
 
 
 
```{r, echo=F, message=F, warning=F}
pwc=data_long %>% pairwise_t_test(PBI_total ~ time, paired=T, p.adjust.method = "bonferroni")
pwc=pwc %>%add_xy_position(x="time")

bxp+
  stat_pvalue_manual(pwc)+
  labs(subtitle=get_test_label(res.aov, detailed = T), caption=get_pwc_label(pwc))

```
 
 
```{r, echo=F, message=F, warning=F}
pwc=data_long %>% pairwise_t_test(PBI_average ~ time, paired=T, p.adjust.method = "bonferroni")
pwc=pwc %>%add_xy_position(x="time")

bxp+
  stat_pvalue_manual(pwc)+
  labs(subtitle=get_test_label(res.aov, detailed = T), caption=get_pwc_label(pwc))

```


## 3 clusters 


```{r, echo=F, message=F, warning=F, eval=T}
PBI_group1=data%>%filter(Average.PBI.Score.8.week <=2 ) %>% select(Patient.ID.Number) %>% pull
PBI_group2=data%>%filter( Average.PBI.Score.8.week >2 ) %>% select(Patient.ID.Number) %>% pull
PBI_group3=data%>%filter( Average.PBI.Score.8.week >3 ) %>% select(Patient.ID.Number) %>% pull

data_long_group1=data_long%>%filter(individual %in% PBI_group1==T)
data_long_group2=data_long%>%filter(individual %in% PBI_group2==T)
data_long_group3=data_long%>%filter(individual %in% PBI_group3==T)
data.frame(group=c("PBI <=2 post-treatment", "PBI>2 post-treatment", "PBI >3 post-treatment"), num_individual=c(nrow(data_long_group1)/2, nrow(data_long_group2)/2, nrow(data_long_group3)/2))
```



## difference at week 8 

```{r, echo=F, message=F, warning=F}
covariates=c("SAI", "sRDI", "SQI", "Fragmentation", "Cortisol.1", "Cortisol.2", "Cortisol.3", "Cortisol.4", "Total.Cortisol", "BMI.kg.m2")
pvalue=numeric()
for (i in 1:length(covariates))
{
  group1=as.numeric(data%>%filter(Average.PBI.Score.8.week<=2) %>% select(covariates[i]) %>% pull())
  group1=group1[!is.na(group1)] # remove na's 
  
  group2=as.numeric(data%>%filter(Average.PBI.Score.8.week>2) %>% select(covariates[i]) %>% pull())
  group2=group2[!is.na(group2)]
  
  two.sample.ttest=t.test(group1, group2)
  pvalue[i]=two.sample.ttest$p.value
}
data.frame(covariates=covariates, pvalue=pvalue)
```

* compare PBI <=2 post-treatment vs PBI >2 post-treatment at week 8 
* two sample t test is used 



```{r, echo=F, message=F, warning=F, eval=F}
g1=ggplot(data=data_long_increase,aes(x=time, y=PBI, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_mean=c(mean(data[data$Patient.ID.Number%in% PBI_increase_indi, ]$PBI.Screening),mean(data[data$Patient.ID.Number%in% PBI_increase_indi,]$PBI.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.8.wk, data$PBI.Screening), max(data$PBI.8.wk, data$PBI.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure
############################
data_long_increase %>%
  group_by(time) %>%
  get_summary_stats(PBI, type = "mean_sd")
###########################
res.aov <- anova_test(data = data_long_increase, dv = PBI, wid = individual, within = time)

get_anova_table(res.aov)
```

```{r, echo=F, message=F, warning=F, eval=F}
g1=ggplot(data=data_long_decrease,aes(x=time, y=PBI, group=individual))+
  geom_line(color="red")+
  geom_point()


g2=ggplot(data.frame(PBI_mean=c(mean(data[data$Patient.ID.Number%in% PBI_decrease_indi, ]$PBI.Screening),mean(data[data$Patient.ID.Number%in% PBI_decrease_indi,]$PBI.8.wk)), time=c("screening", "week 8")), aes(x=time, y=PBI_mean, group=1))+
  ylim(c(min(data$PBI.8.wk, data$PBI.Screening), max(data$PBI.8.wk, data$PBI.Screening)))+
  geom_line(color="red")+
  geom_point()

figure <- ggarrange(g1, g2,
                   # labels = c("A", "B", "C"),
                    ncol = 2, nrow = 1)
figure
############################
data_long_decrease %>%
  group_by(time) %>%
  get_summary_stats(PBI, type = "mean_sd")
###########################
res.aov <- anova_test(data = data_long_decrease, dv = PBI, wid = individual, within = time)

get_anova_table(res.aov)
```




## statistical software 

```{r, echo=F}
R.version
```

