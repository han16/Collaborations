---
title: "07/25/2023"
output: html_document
date: "2023-07-25"
---


```{r setup, include=FALSE}
rm(list=ls())
library(tidyverse)
library(kableExtra)
library(ggpubr)
library(rstatix) # use anova_test function 
library(grid)
library(DT)
library(gridExtra)
library(matrixStats)
library(cowplot)
library(readxl)
set.seed(123)
```




```{r, echo=F, warning=F, message=F}
######## adjust p values 
pvalue_adjust=function(p_value)
{
  p_value_adjust=numeric()
for (i in 1:length(p_value))
{
  if (is.na(p_value[i])==T)
    p_value_adjust[i]=p_value[i]
  if (is.na(p_value[i])==F & p_value[i]<0.0001)
    p_value_adjust[i]="<0.0001"
  if (is.na(p_value[i])==F & p_value[i]>0.0001)
    p_value_adjust[i]=round(p_value[i],4)
}
  return(p_value_adjust)
}
############### summary statistics for continuous variable 
summary_statistics=function(data)
{  # each column is one variable, and row one subject 
  
variables=colnames(data)
num_sample=numeric()
Mean=numeric()
Median=numeric()
SD=numeric()
SE=numeric()
range_min=numeric()
range_max=numeric()
normality_pvalue=numeric()
per_25_quantile=numeric()
per_75_quantile=numeric()

for (i in 1:ncol(data))
{
  observation=data[,i]
  observation=observation[!is.na(observation)] # remove missing values 
  num_sample[i]=length(observation)
  Mean[i]=round(mean(observation),4)
  Median[i]=round(median(observation),4)
  SD[i]=round(sd(observation),4)
  SE[i]=round(SD[i]/sqrt(num_sample[i]),4)
  per_25_quantile[i]=round(quantile(observation, prob=0.25),4)
  per_75_quantile[i]=round(quantile(observation, prob=0.75),4)
  range_min[i]=round(min(observation),4)
  range_max[i]=round(max(observation),4)
  normality_pvalue[i]=round(shapiro.test(observation)$p.value,4)
}

summary_data=data.frame(variable=variables, num_sample=num_sample, Mean=Mean, Median=Median, SD=SD, SE=SE,per_25_quantile, per_75_quantile, Range_low=range_min, Range_upper=range_max, normality_pvalue=normality_pvalue)

summary_data%>%
datatable(extensions = 'Buttons',
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
  
 return(summary_data) 
}

```



```{r, echo=F, message=F, warning=F}
data_2021=read_excel("C:\\Shengtong\\Research\\AllCollaboration\\2023\\202307\\Mohamed\\Endo Lab Learning Preference - 2021(1-102).xlsx")
data_2022A=read_excel("C:\\Shengtong\\Research\\AllCollaboration\\2023\\202307\\Mohamed\\Endo Lab Learning Preference - 2022 (A)(1-107).xlsx")
data_2022B=read_excel("C:\\Shengtong\\Research\\AllCollaboration\\2023\\202307\\Mohamed\\Endo Lab Learning Preference - 2022 (B)(1-106).xlsx")
data_2023=read_excel("C:\\Shengtong\\Research\\AllCollaboration\\2023\\202307\\Mohamed\\Endo Lab Learning Preference - 2023 (B)(1-94).xlsx")
```


## Q1: Please rank these methods of receiving information for lab projects from 1 to 4, with 1 being your most preferred delivery method and 4 being your least preferred


### 2021


```{r, echo=F, message=F, warning=F}
colnames(data_2021)[6]="Q1"
data_2021$Q1=tolower(data_2021$Q1) # unify the response all into lower case 
data_2021_plot=data_2021 %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2021),4)) 

data_2021_plot=data_2021_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2021_plot)), sep="_"))

  
g1=ggplot(data_2021_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2021_plot2=data.frame(Q1=sapply(strsplit(data_2021$Q1, ";"), "[", 1)) %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2021),4)) 

g1=ggplot(data_2021_plot2, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot2, aes(x=Q1, y=n, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```





### 2022_A 


```{r, echo=F, message=F, warning=F}
colnames(data_2022A)[6]="Q1"
data_2022A$Q1=tolower(data_2022A$Q1)
data_2022A_plot=data_2022A %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

data_2022A_plot=data_2022A_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022A_plot)), sep="_"))

  
g1=ggplot(data_2022A_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2022A_plot2=data.frame(Q1=sapply(strsplit(data_2022A$Q1, ";"), "[", 1)) %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

g1=ggplot(data_2022A_plot2, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot2, aes(x=Q1, y=n, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


### 2022_B 


```{r, echo=F, message=F, warning=F}
colnames(data_2022B)[6]="Q1"
data_2022B$Q1=tolower(data_2022B$Q1)
data_2022B_plot=data_2022B %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot=data_2022B_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022B_plot)), sep="_"))

  
g1=ggplot(data_2022B_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2022B_plot2=data.frame(Q1=sapply(strsplit(data_2022B$Q1, ";"), "[", 1)) %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

g1=ggplot(data_2022B_plot2, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot2, aes(x=Q1, y=n, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



### 2023 


```{r, echo=F, message=F, warning=F}
colnames(data_2023)[6]="Q1"
data_2023$Q1=tolower(data_2023$Q1)
data_2023_plot=data_2023 %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot=data_2023_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2023_plot)), sep="_"))

  
g1=ggplot(data_2023_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2023_plot2=data.frame(Q1=sapply(strsplit(data_2023$Q1, ";"), "[", 1)) %>% dplyr::count(Q1)%>% mutate(prop=round(n/nrow(data_2023),4)) 

g1=ggplot(data_2023_plot2, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot2, aes(x=Q1, y=n, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


### Combine across all years 

```{r, echo=F, message=F, warning=F}
Q1_all_response=unique(c(unique(data_2021$Q1), unique(data_2022A$Q1), unique(data_2022B$Q1), unique(data_2023$Q1)))
all_response_data=data.frame(Q1=Q1_all_response)
data_2021_plot_full_response=full_join(data_2021_plot, all_response_data) %>% select(Q1, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0 
data_2022A_plot_full_response=full_join(data_2022A_plot, all_response_data) %>% select(Q1, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2022B_plot_full_response=full_join(data_2022B_plot, all_response_data) %>% select(Q1, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2023_plot_full_response=full_join(data_2023_plot, all_response_data) %>% select(Q1, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0

combine_data=data.frame(Q1=c(data_2021_plot_full_response$Q1, data_2022A_plot_full_response$Q1, data_2022B_plot_full_response$Q1, data_2023_plot_full_response$Q1),n=c(data_2021_plot_full_response$n, data_2022A_plot_full_response$n, data_2022B_plot_full_response$n, data_2023_plot_full_response$n), prop=c(data_2021_plot_full_response$prop, data_2022A_plot_full_response$prop, data_2022B_plot_full_response$prop, data_2023_plot_full_response$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=20) )


ggplot(combine_data, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="right")+
   theme(legend.text=element_text(size=7))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=1.5)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```



```{r, echo=F, message=F, warning=F}
combine_data=data.frame(Q1=c(data_2021_plot2$Q1, data_2022A_plot2$Q1, data_2022B_plot2$Q1, data_2023_plot2$Q1),n=c(data_2021_plot2$n, data_2022A_plot2$n, data_2022B_plot2$n, data_2023_plot2$n), prop=c(data_2021_plot2$prop, data_2022A_plot2$prop, data_2022B_plot2$prop, data_2023_plot2$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=nrow(data_2021_plot2)))


ggplot(combine_data, aes(x=Q1, y=prop, fill=Q1)) +geom_bar(stat="identity")+
  theme(legend.position="right")+
   theme(legend.text=element_text(size=9))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




#### comparison 


```{r, echo=F, message=F, warning=F}

ggplot(combine_data %>% filter(Q1=="live demo"), aes(x=year, y=prop, fill=year))+ 
geom_bar(position = "dodge",stat="identity")+
   xlab("")+ylab("%")+
   ylim(c(0,1))+
   theme(axis.text.x = element_text(angle =0, vjust = 0.5, size=8))+
   ggtitle("live demo")+
   geom_text(aes(label=prop*100), position=position_dodge(width=0.9), vjust=1.25)+  # add numbers over bars 
  geom_signif(annotations ="p<0.0001", y_position = 0.82  ,xmin=1, xmax=2, size=1, vjust=-0.5, textsize=3.5, color="red")+ # textsize is for text over the bar; size is for width of lines 
   geom_signif(annotations ="p<0.0001", y_position = 0.89  ,xmin=1, xmax=3, size=1, vjust=-0.5, textsize=3.5, color="red")+
  geom_signif(annotations ="p<0.0001", y_position = 0.96  ,xmin=1, xmax=4, size=1, vjust=-0.5, textsize=3.5, color="red")+
   theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  theme(legend.title=element_blank())+
  theme(legend.position = "none")

############ compute p value 
######## 2021 vs 2022A
#res <- prop.test(x = c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2022A))) # use two sample proportion test 
# or fisher.test(matrix(c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2021)-data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2022A)-data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull)), nrow=2))

#res$p.value

######## 2021 vs 2022B
#res <- prop.test(x = c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022B_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2022B))) # use two sample proportion test 
#res$p.value


######## 2021 vs 2023
#res <- prop.test(x = c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2023_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2023))) # use two sample proportion test 
#res$p.value

```



## Q2: If you prefer video demos, please rank these options 1 to 3, with 1 being your most preferred video style and 3 being your least preferred


### 2021 

```{r, echo=F, message=F, warning=F}
colnames(data_2021)[7]="Q2"
data_2021$Q2=tolower(data_2021$Q2) # unify the response all into lower case 
data_2021_plot=data_2021 %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2021),4)) 

data_2021_plot=data_2021_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2021_plot)), sep="_"))

  
g1=ggplot(data_2021_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2021_plot2=data.frame(Q2=sapply(strsplit(data_2021$Q2, ";"), "[", 1)) %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2021),4)) 

g1=ggplot(data_2021_plot2, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot2, aes(x=Q2, y=n, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```





### 2022A




```{r, echo=F, message=F, warning=F}
colnames(data_2022A)[7]="Q2"
data_2022A$Q2=tolower(data_2022A$Q2) # unify the response all into lower case 
data_2022A_plot=data_2022A %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

data_2022A_plot=data_2022A_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022A_plot)), sep="_"))

  
g1=ggplot(data_2022A_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2022A_plot2=data.frame(Q2=sapply(strsplit(data_2022A$Q2, ";"), "[", 1)) %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

g1=ggplot(data_2022A_plot2, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot2, aes(x=Q2, y=n, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



### 2022B




```{r, echo=F, message=F, warning=F}
colnames(data_2022B)[7]="Q2"
data_2022B$Q2=tolower(data_2022B$Q2) # unify the response all into lower case 
data_2022B_plot=data_2022B %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot=data_2022B_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022B_plot)), sep="_"))

  
g1=ggplot(data_2022B_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2022B_plot2=data.frame(Q2=sapply(strsplit(data_2022B$Q2, ";"), "[", 1)) %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

g1=ggplot(data_2022B_plot2, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot2, aes(x=Q2, y=n, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```




### 2023




```{r, echo=F, message=F, warning=F}
colnames(data_2023)[7]="Q2"
data_2023$Q2=tolower(data_2023$Q2) # unify the response all into lower case 
data_2023_plot=data_2023 %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot=data_2023_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2023_plot)), sep="_"))

  
g1=ggplot(data_2023_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2023_plot2=data.frame(Q2=sapply(strsplit(data_2023$Q2, ";"), "[", 1)) %>% dplyr::count(Q2)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

g1=ggplot(data_2023_plot2, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot2, aes(x=Q2, y=n, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```




### Combine across all years 

```{r, echo=F, message=F, warning=F}
Q2_all_response=unique(c(unique(data_2021$Q2), unique(data_2022A$Q2), unique(data_2022B$Q2), unique(data_2023$Q2)))
all_response_data=data.frame(Q2=Q2_all_response)
data_2021_plot_full_response=full_join(data_2021_plot, all_response_data) %>% select(Q2, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0 
data_2022A_plot_full_response=full_join(data_2022A_plot, all_response_data) %>% select(Q2, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2022B_plot_full_response=full_join(data_2022B_plot, all_response_data) %>% select(Q2, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2023_plot_full_response=full_join(data_2023_plot, all_response_data) %>% select(Q2, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0

combine_data=data.frame(Q2=c(data_2021_plot_full_response$Q2, data_2022A_plot_full_response$Q2, data_2022B_plot_full_response$Q2, data_2023_plot_full_response$Q2),n=c(data_2021_plot_full_response$n, data_2022A_plot_full_response$n, data_2022B_plot_full_response$n, data_2023_plot_full_response$n), prop=c(data_2021_plot_full_response$prop, data_2022A_plot_full_response$prop, data_2022B_plot_full_response$prop, data_2023_plot_full_response$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=length(Q2_all_response)) )


ggplot(combine_data, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
   theme(legend.text=element_text(size=7))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




```{r, echo=F, message=F, warning=F}
combine_data=data.frame(Q2=c(data_2021_plot2$Q2, data_2022A_plot2$Q2, data_2022B_plot2$Q2, data_2023_plot2$Q2),n=c(data_2021_plot2$n, data_2022A_plot2$n, data_2022B_plot2$n, data_2023_plot2$n), prop=c(data_2021_plot2$prop, data_2022A_plot2$prop, data_2022B_plot2$prop, data_2023_plot2$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=nrow(data_2021_plot2)))


ggplot(combine_data, aes(x=Q2, y=prop, fill=Q2)) +geom_bar(stat="identity")+
  theme(legend.position="right")+
   theme(legend.text=element_text(size=9))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




```{r, echo=F, message=F, warning=F}

ggplot(combine_data %>% filter(Q2=="demo with instructor speaking throughout the video"), aes(x=year, y=prop, fill=year))+ 
geom_bar(position = "dodge",stat="identity")+
   xlab("")+ylab("%")+
   ylim(c(0,1))+
   theme(axis.text.x = element_text(angle =0, vjust = 0.5, size=8))+
   ggtitle("demo with instructor speaking throughout the vide")+
   geom_text(aes(label=prop*100), position=position_dodge(width=0.9), vjust=1.25)+  # add numbers over bars 
  geom_signif(annotations ="p=0.832", y_position = 0.82  ,xmin=1, xmax=2, size=1, vjust=-0.5, textsize=3.5, color="red")+ # textsize is for text over the bar; size is for width of lines 
   geom_signif(annotations ="p=1.000", y_position = 0.89  ,xmin=1, xmax=3, size=1, vjust=-0.5, textsize=3.5, color="red")+
  geom_signif(annotations ="p=0.242", y_position = 0.96  ,xmin=1, xmax=4, size=1, vjust=-0.5, textsize=3.5, color="red")+
   theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  theme(legend.title=element_blank())+
  theme(legend.position = "none")

############ compute p value 
######## 2021 vs 2022A
#res <- prop.test(x = c(data_2021_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2022A))) # use two sample proportion test 
# or fisher.test(matrix(c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2021)-data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2022A)-data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull)), nrow=2))

#res$p.value

######## 2021 vs 2022B
res <- prop.test(x = c(data_2021_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull, data_2022B_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2022B))) # use two sample proportion test 
#res$p.value


######## 2021 vs 2023
#res <- prop.test(x = c(data_2021_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull, data_2023_plot2%>% filter(Q2=="demo with instructor speaking throughout the video") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2023))) # use two sample proportion test 
#res$p.value

```




## Q3: If you prefer the video demos with a subtitle and music in the background, what kind of music do you prefer?


### 2021 


```{r, echo=F, message=F, warning=F}
colnames(data_2021)[8]="Q3"
data_2021$Q3=tolower(data_2021$Q3) # unify the response all into lower case
data_2021_plot=data_2021 %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2021),4)) 

data_2021_plot=data_2021_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2021_plot)), sep="_"))

  
g1=ggplot(data_2021_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2021_plot2=data.frame(Q3=sapply(strsplit(data_2021$Q3, ";"), "[", 1)) %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2021),4)) 

data_2021_plot2_regroup=data.frame(Q3=c("classical", "country", "pop", "rap", "mix", "other"), n=c(data_2021_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
                                                                                        data_2021_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                        data_2021_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                        data_2021_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                        data_2021_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2021)-sum(c(data_2021_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull()))), prop=c(data_2021_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2021)-sum(c(data_2021_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), data_2021_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull())))/nrow(data_2021))

g1=ggplot(data_2021_plot2_regroup, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2021_plot2_regroup, aes(x=Q3, y=n, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2021_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2021",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


### 2022A 


```{r, echo=F, message=F, warning=F}
colnames(data_2022A)[8]="Q3"
data_2022A$Q3=tolower(data_2022A$Q3) # unify the response all into lower case
data_2022A_plot=data_2022A %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

data_2022A_plot=data_2022A_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022A_plot)), sep="_"))

  
g1=ggplot(data_2022A_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 
data_2022A_plot2=data.frame(Q3=sapply(strsplit(data_2022A$Q3, ";"), "[", 1)) %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

data_2022A_plot2_regroup=data.frame(Q3=c("classical", "country", "pop", "rap", "mix", "other"), n=c(data_2022A_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
                                                                                      data_2022A_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                        data_2022A_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                        data_2022A_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                        data_2022A_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2022A)-sum(c(data_2022A_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull()))), 
prop=c(data_2022A_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
data_2022A_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
data_2022A_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
data_2022A_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
data_2022A_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2022A)-sum(c(data_2022A_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), data_2022A_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull())))/nrow(data_2022A))

g1=ggplot(data_2022A_plot2_regroup, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot2_regroup, aes(x=Q3, y=n, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```






### 2022B 


```{r, echo=F, message=F, warning=F}
colnames(data_2022B)[8]="Q3"
data_2022B$Q3=tolower(data_2022B$Q3) # unify the response all into lower case
data_2022B_plot=data_2022B %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot=data_2022B_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022B_plot)), sep="_"))

  
g1=ggplot(data_2022B_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 

data_2022B_plot2=data.frame(Q3=sapply(strsplit(data_2022B$Q3, ";"), "[", 1)) %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot2_regroup=data.frame(Q3=c("classical", "country", "pop", "rap", "mix", "other"), n=c(data_2022B_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
                                                                                      data_2022B_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                        data_2022B_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                        data_2022B_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                        data_2022B_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2022B)-sum(c(data_2022B_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2022B_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                                                      data_2022B_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                                                      data_2022B_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                                                      data_2022B_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull()))), 
prop=c(data_2022B_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
data_2022B_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
data_2022B_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
data_2022B_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
data_2022B_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2022B)-sum(c(data_2022B_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2022B_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                      data_2022B_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                      data_2022B_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                      data_2022B_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull())))/nrow(data_2022B))

g1=ggplot(data_2022B_plot2_regroup, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot2_regroup, aes(x=Q3, y=n, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```





### 2023 


```{r, echo=F, message=F, warning=F}
colnames(data_2023)[8]="Q3"
data_2023$Q3=tolower(data_2023$Q3) # unify the response all into lower case
data_2023_plot=data_2023 %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot=data_2023_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2023_plot)), sep="_"))

  
g1=ggplot(data_2023_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```




```{r, echo=F, message=F, warning=F}
# sapply(strsplit(data_2021$Q1, ";"), "[", 1)   ## extract the most favoriate one 

data_2023_plot2=data.frame(Q3=sapply(strsplit(data_2023$Q3, ";"), "[", 1)) %>% dplyr::count(Q3)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot2_regroup=data.frame(Q3=c("classical", "country", "pop", "rap", "mix", "other"), n=c(data_2023_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
                                                                                      data_2023_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                        data_2023_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                        data_2023_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                        data_2023_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2023)-sum(c(data_2023_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2023_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
                                                                                                                      data_2023_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
                                                                                                                      data_2023_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
                                                                                                                      data_2023_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull()))), 
prop=c(data_2023_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull(), nrow(data_2023)-sum(c(data_2023_plot2%>%filter(Q3=="classical") %>% select(n) %>% pull(), data_2023_plot2%>%filter(Q3=="country") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="pop") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="rap") %>% select(n) %>% pull(), 
data_2023_plot2%>%filter(Q3=="mix") %>% select(n) %>% pull())))/nrow(data_2023))

g1=ggplot(data_2023_plot2_regroup, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  theme(axis.text.x = element_blank())+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot2_regroup, aes(x=Q3, y=n, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  #theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
    theme(axis.text.x = element_blank())+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="right") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot2%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```








### Combine across all years 

```{r, echo=F, message=F, warning=F}
Q3_all_response=unique(c(unique(data_2021$Q3), unique(data_2022A$Q3), unique(data_2022B$Q3), unique(data_2023$Q3)))
all_response_data=data.frame(Q3=Q3_all_response)
data_2021_plot_full_response=full_join(data_2021_plot, all_response_data) %>% select(Q3, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0 
data_2022A_plot_full_response=full_join(data_2022A_plot, all_response_data) %>% select(Q3, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2022B_plot_full_response=full_join(data_2022B_plot, all_response_data) %>% select(Q3, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2023_plot_full_response=full_join(data_2023_plot, all_response_data) %>% select(Q3, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0

combine_data=data.frame(Q3=c(data_2021_plot_full_response$Q3, data_2022A_plot_full_response$Q3, data_2022B_plot_full_response$Q3, data_2023_plot_full_response$Q3),n=c(data_2021_plot_full_response$n, data_2022A_plot_full_response$n, data_2022B_plot_full_response$n, data_2023_plot_full_response$n), prop=c(data_2021_plot_full_response$prop, data_2022A_plot_full_response$prop, data_2022B_plot_full_response$prop, data_2023_plot_full_response$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=length(Q3_all_response)) )


ggplot(combine_data, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
   theme(legend.text=element_text(size=7))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




```{r, echo=F, message=F, warning=F}
combine_data=data.frame(Q3=c(data_2021_plot2_regroup$Q3, data_2022A_plot2_regroup$Q3, data_2022B_plot2_regroup$Q3, data_2023_plot2_regroup$Q3),n=c(data_2021_plot2_regroup$n, data_2022A_plot2_regroup$n, data_2022B_plot2_regroup$n, data_2023_plot2_regroup$n), prop=c(data_2021_plot2_regroup$prop, data_2022A_plot2_regroup$prop, data_2022B_plot2_regroup$prop, data_2023_plot2_regroup$prop), year=rep(c("2021", "2022A", "2022B", "2023"), each=nrow(data_2021_plot2_regroup)))


ggplot(combine_data, aes(x=Q3, y=prop, fill=Q3)) +geom_bar(stat="identity")+
  theme(legend.position="right")+
   theme(legend.text=element_text(size=9))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




```{r, echo=F, message=F, warning=F}

ggplot(combine_data %>% filter(Q3=="classical"), aes(x=year, y=prop, fill=year))+ 
geom_bar(position = "dodge",stat="identity")+
   xlab("")+ylab("%")+
   ylim(c(0,1))+
   theme(axis.text.x = element_text(angle =0, vjust = 0.5, size=8))+
   ggtitle("classical")+
   geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.9), vjust=1.25)+  # add numbers over bars 
  geom_signif(annotations ="p=0.012", y_position = 0.52  ,xmin=1, xmax=2, size=1, vjust=-0.5, textsize=3.5, color="red")+ # textsize is for text over the bar; size is for width of lines 
   geom_signif(annotations ="p=0.045", y_position = 0.59  ,xmin=1, xmax=3, size=1, vjust=-0.5, textsize=3.5, color="red")+
  geom_signif(annotations ="p<0.001", y_position = 0.66  ,xmin=1, xmax=4, size=1, vjust=-0.5, textsize=3.5, color="red")+
   theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  theme(legend.title=element_blank())+
  theme(legend.position = "none")

############ compute p value 
######## 2021 vs 2022A
#res <- prop.test(x = c(data_2021_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull, 
#                       data_2022A_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull), n = #c(nrow(data_2021), nrow(data_2022A))) # use two sample proportion test 
# or fisher.test(matrix(c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2021)-data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2022A)-data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull)), nrow=2))

#res$p.value

######## 2021 vs 2022B
#res <- prop.test(x = c(data_2021_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull, data_2022B_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2022B))) # use two sample proportion test 
#res$p.value


######## 2021 vs 2023
#res <- prop.test(x = c(data_2021_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull, data_2023_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull), n = c(nrow(data_2021), nrow(data_2023))) # use two sample proportion test 
#res$p.value

```




## Q4: If there's only one method of receiving the information for lab projects, which one will you choose?




### 2022A 


```{r, echo=F, message=F, warning=F}
colnames(data_2022A)[9]="Q4"
data_2022A$Q4=tolower(data_2022A$Q4) # unify the response all into lower case
data_2022A_plot=data_2022A %>% dplyr::count(Q4)%>% mutate(prop=round(n/nrow(data_2022A),4)) 

data_2022A_plot=data_2022A_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022A_plot)), sep="_"))

  
g1=ggplot(data_2022A_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022A_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022A_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022A",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```

### 2022B 


```{r, echo=F, message=F, warning=F}
colnames(data_2022B)[9]="Q4"
data_2022B$Q4=tolower(data_2022B$Q4) # unify the response all into lower case
data_2022B_plot=data_2022B %>% dplyr::count(Q4)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot=data_2022B_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022B_plot)), sep="_"))

  
g1=ggplot(data_2022B_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```


### 2023 


```{r, echo=F, message=F, warning=F}
colnames(data_2023)[9]="Q4"
data_2023$Q4=tolower(data_2023$Q4) # unify the response all into lower case
data_2023_plot=data_2023 %>% dplyr::count(Q4)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot=data_2023_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2023_plot)), sep="_"))

  
g1=ggplot(data_2023_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



### Combine across all years 

```{r, echo=F, message=F, warning=F}
Q4_all_response=unique(c(unique(data_2022A$Q4), unique(data_2022B$Q4), unique(data_2023$Q4)))
all_response_data=data.frame(Q4=Q4_all_response)
data_2022A_plot_full_response=full_join(data_2022A_plot, all_response_data) %>% select(Q4, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2022B_plot_full_response=full_join(data_2022B_plot, all_response_data) %>% select(Q4, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2023_plot_full_response=full_join(data_2023_plot, all_response_data) %>% select(Q4, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0

combine_data=data.frame(Q4=c( data_2022A_plot_full_response$Q4, data_2022B_plot_full_response$Q4, data_2023_plot_full_response$Q4),n=c(data_2022A_plot_full_response$n, data_2022B_plot_full_response$n, data_2023_plot_full_response$n), prop=c( data_2022A_plot_full_response$prop, data_2022B_plot_full_response$prop, data_2023_plot_full_response$prop), year=rep(c( "2022A", "2022B", "2023"), each=length(Q4_all_response)) )


ggplot(combine_data, aes(x=Q4, y=prop, fill=Q4)) +geom_bar(stat="identity")+
  theme(legend.position="right")+
   theme(legend.text=element_text(size=7))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```




```{r, echo=F, message=F, warning=F}

ggplot(combine_data %>% filter(Q4=="live demo"), aes(x=year, y=prop, fill=year))+ 
geom_bar(position = "dodge",stat="identity")+
   xlab("")+ylab("%")+
   ylim(c(0,1))+
   theme(axis.text.x = element_text(angle =0, vjust = 0.5, size=8))+
   ggtitle("classical")+
   geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.9), vjust=1.25)+  # add numbers over bars 
  geom_signif(annotations ="p=0.371", y_position = 0.72  ,xmin=1, xmax=2, size=1, vjust=-0.5, textsize=3.5, color="red")+ # textsize is for text over the bar; size is for width of lines 
   geom_signif(annotations ="p=0.232", y_position = 0.79  ,xmin=1, xmax=3, size=1, vjust=-0.5, textsize=3.5, color="red")+
  #geom_signif(annotations ="p<0.001", y_position = 0.86  ,xmin=1, xmax=4, size=1, vjust=-0.5, textsize=3.5, color="red")+
   theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  theme(legend.title=element_blank())+
  theme(legend.position = "none")

############ compute p value 
######## 2021 vs 2022A
#res <- prop.test(x = c(data_2021_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull, 
#                       data_2022A_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull), n = #c(nrow(data_2021), nrow(data_2022A))) # use two sample proportion test 
# or fisher.test(matrix(c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2021)-data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2022A)-data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull)), nrow=2))

#res$p.value

######## 2022A vs 2022B
#res <- prop.test(x = c(data_2022A_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull, data_2022B_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2022A), nrow(data_2022B))) # use two sample proportion test 
#res$p.value


######## 2022A vs 2023
#res <- prop.test(x = c(data_2022A_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull, data_2023_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2022A), nrow(data_2023))) # use two sample proportion test 
#res$p.value

```





## Q5: If you prefer the Live Demo, which Live demo style you prefer most? 


### 2022B 


```{r, echo=F, message=F, warning=F}
colnames(data_2022B)[10]="Q5"
data_2022B$Q5=tolower(data_2022B$Q5) # unify the response all into lower case
data_2022B_plot=data_2022B %>% dplyr::count(Q5)%>% mutate(prop=round(n/nrow(data_2022B),4)) 

data_2022B_plot=data_2022B_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2022B_plot)), sep="_"))

  
g1=ggplot(data_2022B_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2022B_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2022B_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2022B",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



### 2023 


```{r, echo=F, message=F, warning=F}
colnames(data_2023)[10]="Q5"
data_2023$Q5=tolower(data_2023$Q5) # unify the response all into lower case
data_2023_plot=data_2023 %>% dplyr::count(Q5)%>% mutate(prop=round(n/nrow(data_2023),4)) 

data_2023_plot=data_2023_plot%>% mutate(Response=paste("Res", seq(1:nrow(data_2023_plot)), sep="_"))

  
g1=ggplot(data_2023_plot, aes(x=Response, y=prop, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("%")+ylim(c(0,1))+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
  #ggtitle(paste(questions[i]))+
  #theme(plot.title = element_text(hjust = 0.5, size=10))  #center the title 
#g1
  g2=ggplot(data_2023_plot, aes(x=Response, y=n, fill=Response)) +geom_bar(stat="identity")+
  theme(legend.position="none")+
  theme(axis.text.x = element_text(angle = 30, vjust = 0.5, size=8))+
  ylab("count")+
    xlab("")+
  geom_text(aes(label=n), position=position_dodge(width=0.6), vjust=-0.25, size=3)#+  # add numbers over bars
#questions[1]
  figure=ggarrange(g1, g2, common.legend = TRUE, legend="none") 
annotate_figure(figure,
                top = text_grob("", color = "red", face = "bold", size = 14),
#                bottom = text_grob("Data source: \n ToothGrowth data set", color = "blue",
#                                   hjust = 1, x = 1, face = "italic", size = 10),
#                left = text_grob("Tooth length", color = "green", rot = 90),
#                right = "I'm done, thanks :-)!",
#                fig.lab = "Figure 1", fig.lab.face = "bold"
)
################
data_2023_plot%>%
datatable(extensions = 'Buttons',
          caption="year 2023",
            options = list(dom = 'Blfrtip',
                           buttons = c('copy', 'csv', 'excel', 'pdf', 'print'),
                           lengthMenu = list(c(10,25,50,-1),
                                             c(10,25,50,"All"))))
```



### Combine across all years 

```{r, echo=F, message=F, warning=F}
Q5_all_response=unique(c(unique(data_2022B$Q5), unique(data_2023$Q5)))
all_response_data=data.frame(Q5=Q5_all_response)
#data_2022A_plot_full_response=full_join(data_2022A_plot, all_response_data) %>% select(Q4, n ,prop) %>% replace(is.na(.), 0) # replace NAs with 0
data_2022B_plot_full_response=full_join(data_2022B_plot, all_response_data) %>% select(Q5, n ,prop) 
#%>% replace(is.na(.), 0) # replace NAs with 0
data_2023_plot_full_response=full_join(data_2023_plot, all_response_data) %>% select(Q5, n ,prop) 
#%>% replace(is.na(.), 0) # replace NAs with 0

combine_data=data.frame(Q5=c(data_2022B_plot_full_response$Q5, data_2023_plot_full_response$Q5),n=c(data_2022B_plot_full_response$n, data_2023_plot_full_response$n), prop=c( data_2022B_plot_full_response$prop, data_2023_plot_full_response$prop), year=rep(c( "2022B", "2023"), each=length(Q5_all_response)) )


ggplot(combine_data, aes(x=Q5, y=prop, fill=Q5)) +geom_bar(stat="identity")+
  theme(legend.position="bottom")+
   theme(legend.text=element_text(size=7))+ # text size in legend 
  theme(legend.title=element_blank())+ # no legend title 
  ylab("%")+
    xlab("")+
  geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.6), vjust=-0.25, size=3)+#+  # add numbers over bars
  labs(x = NULL) + 
  guides(x = "none")+
  facet_wrap(~year)
```


```{r, echo=F, message=F, warning=F}

ggplot(combine_data %>% filter(Q5=="demo of the procedure step-wise"), aes(x=year, y=prop, fill=year))+ 
geom_bar(position = "dodge",stat="identity")+
   xlab("")+ylab("%")+
   ylim(c(0,1))+
   theme(axis.text.x = element_text(angle =0, vjust = 0.5, size=8))+
   ggtitle("demo of the procedure step-wise")+
   geom_text(aes(label=round(prop,4)*100), position=position_dodge(width=0.9), vjust=1.25)+  # add numbers over bars 
  geom_signif(annotations ="p=0.074", y_position = 0.52  ,xmin=1, xmax=2, size=1, vjust=-0.5, textsize=3.5, color="red")+ # textsize is for text over the bar; size is for width of lines 
   #geom_signif(annotations ="p=0.232", y_position = 0.79  ,xmin=1, xmax=3, size=1, vjust=-0.5, textsize=3.5, color="red")+
  #geom_signif(annotations ="p<0.001", y_position = 0.86  ,xmin=1, xmax=4, size=1, vjust=-0.5, textsize=3.5, color="red")+
   theme(plot.title = element_text(hjust = 0.5, size=15))+  #center the title
  theme(legend.title=element_blank())+
  theme(legend.position = "none")

############ compute p value 
######## 2021 vs 2022A
#res <- prop.test(x = c(data_2021_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull, 
#                       data_2022A_plot2_regroup%>% filter(Q3=="classical") %>% select(n) %>% pull), n = #c(nrow(data_2021), nrow(data_2022A))) # use two sample proportion test 
# or fisher.test(matrix(c(data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2021)-data_2021_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull, nrow(data_2022A)-data_2022A_plot2%>% filter(Q1=="live demo") %>% select(n) %>% pull)), nrow=2))

#res$p.value

######## 2022A vs 2022B
#res <- prop.test(x = c(data_2022A_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull, data_2022B_plot%>% filter(Q4=="live demo") %>% select(n) %>% pull), n = c(nrow(data_2022A), nrow(data_2022B))) # use two sample proportion test 
#res$p.value


######## 2022B vs 2023
#res <- prop.test(x = c(data_2022B_plot%>% filter(Q5=="demo of the procedure step-wise") %>% select(n) %>% pull, data_2023_plot%>% filter(Q5=="demo of the procedure step-wise") %>% select(n) %>% pull), n = c(nrow(data_2022B), nrow(data_2023))) # use two sample proportion test 
#res$p.value

```
